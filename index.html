<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cardiorenal Journey — Patient Stories</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #64748b;
      --text: #0f172a;
    }
    .dark :root, html.dark {
      --bg: #0b1220;
      --card: #0f172a;
      --muted:#94a3b8;
      --text:#e2e8f0;
    }
    body { background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Inter, "Helvetica Neue", Arial; }
    .card { background: var(--card); }
    .muted { color: var(--muted); }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:18px;height:18px;border-radius:9999px;background:#3b82f6 }
    input[type=range]::-moz-range-thumb { width:18px;height:18px;border-radius:9999px;background:#3b82f6 }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="sticky top-0 z-30 border-b border-slate-200/40 backdrop-blur card">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">Cardiorenal Journey — Patient Stories</h1>
        <p class="muted text-sm">Select a hypothetical patient, review risks, and simulate treatment impact.</p>
      </div>
      <div class="flex items-center gap-3">
        <span class="muted text-sm">Theme</span>
        <button id="themeBtn"
          class="px-3 py-1.5 rounded-lg border text-sm hover:opacity-90 transition card">Light</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- Patient picker -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-1 card rounded-2xl shadow-sm p-5">
        <h2 class="text-lg font-semibold mb-1">Select a hypothetical patient</h2>
        <p class="muted text-sm mb-4">Tap a profile to pre-fill inputs. You can edit anything afterward.</p>
        <div class="grid grid-cols-2 gap-4">
          <!-- Arjun -->
          <button id="pickArjun" class="group rounded-2xl border shadow-sm p-4 text-left hover:shadow transition card">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-bold">A</div>
              <div>
                <div class="font-semibold">Arjun (35)</div>
                <div class="muted text-xs">IT engineer, Delhi</div>
              </div>
            </div>
            <p class="text-sm mt-3">
              Arjun is a 35-year-old non-smoker from Delhi with early hypertension controlled on ACEi.
              He’s keen on preventing kidney and heart problems after his father’s bypass at 58.
            </p>
          </button>
          <!-- Meera -->
          <button id="pickMeera" class="group rounded-2xl border shadow-sm p-4 text-left hover:shadow transition card">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-full bg-pink-100 flex items-center justify-center text-pink-700 font-bold">M</div>
              <div>
                <div class="font-semibold">Meera (41)</div>
                <div class="muted text-xs">School teacher, Pune</div>
              </div>
            </div>
            <p class="text-sm mt-3">
              Meera is a 41-year-old with type 2 diabetes and dyslipidaemia. Blood pressure has been high
              and UACR is elevated; she’s motivated to improve diet and start SGLT2i if beneficial.
            </p>
          </button>
        </div>
      </div>

      <!-- Inputs -->
      <div class="lg:col-span-2 card rounded-2xl shadow-sm p-5">
        <h2 class="text-lg font-semibold mb-1">Clinical inputs</h2>
        <p class="muted text-sm mb-4">These drive eGFR, KFRE (2 &amp; 5 yr), PREVENT CVD risk, and CKM stage.</p>

        <div class="grid md:grid-cols-3 gap-6">
          <!-- Demographics -->
          <div class="space-y-4">
            <div>
              <label class="text-sm">Age: <span id="ageVal" class="font-semibold">55</span> yrs</label>
              <input id="age" type="range" min="18" max="90" value="55" class="w-full">
            </div>
            <div>
              <label class="text-sm">Sex</label>
              <select id="sex" class="mt-1 w-full rounded-md border px-3 py-2 bg-transparent card">
                <option value="male">Male</option>
                <option value="female">Female</option>
              </select>
            </div>
            <div>
              <label class="text-sm">Population for BMI thresholds</label>
              <select id="population" class="mt-1 w-full rounded-md border px-3 py-2 bg-transparent card">
                <option value="general">General</option>
                <option value="asian" selected>South/East Asian</option>
              </select>
            </div>
          </div>

          <!-- Anthropometry -->
          <div class="space-y-4">
            <div>
              <label class="text-sm">Height: <span id="htVal" class="font-semibold">170</span> cm</label>
              <input id="height" type="range" min="130" max="210" value="170" class="w-full">
            </div>
            <div>
              <label class="text-sm">Weight: <span id="wtVal" class="font-semibold">75</span> kg</label>
              <input id="weight" type="range" min="35" max="160" value="75" class="w-full">
            </div>
            <div class="text-sm">
              BMI: <span id="bmi" class="font-semibold">26.0</span> kg/m² •
              <span id="bmiCat" class="font-medium"></span>
            </div>
          </div>

          <!-- Labs -->
          <div class="space-y-4">
            <div>
              <label class="text-sm">Serum creatinine: <span id="scrVal" class="font-semibold">1.20</span> mg/dL</label>
              <input id="scr" type="range" min="0.4" max="6.0" step="0.01" value="1.20" class="w-full">
            </div>
            <div>
              <label class="text-sm">UACR: <span id="uacrVal" class="font-semibold">120</span> mg/g</label>
              <input id="uacr" type="range" min="1" max="3000" step="1" value="120" class="w-full">
            </div>
            <div>
              <label class="text-sm">SBP: <span id="sbpVal" class="font-semibold">142</span> mmHg</label>
              <input id="sbp" type="range" min="90" max="200" value="142" class="w-full">
            </div>
          </div>
        </div>

        <!-- Conditions & meds -->
        <div class="grid md:grid-cols-4 gap-4 mt-6">
          <label class="flex items-center gap-2 text-sm"><input id="diabetes" type="checkbox" class="scale-110"> Diabetes</label>
          <label class="flex items-center gap-2 text-sm"><input id="hypertension" type="checkbox" class="scale-110" checked> Hypertension</label>
          <label class="flex items-center gap-2 text-sm"><input id="dyslipidemia" type="checkbox" class="scale-110"> Dyslipidaemia</label>
          <label class="flex items-center gap-2 text-sm"><input id="smoker" type="checkbox" class="scale-110"> Current smoker</label>
          <label class="flex items-center gap-2 text-sm"><input id="bpControlled" type="checkbox" class="scale-110"> BP controlled (&lt;130)</label>
          <label class="flex items-center gap-2 text-sm"><input id="acei" type="checkbox" class="scale-110"> On ACEi/ARB</label>
          <label class="flex items-center gap-2 text-sm"><input id="sglt2i" type="checkbox" class="scale-110"> On SGLT2i</label>
          <label class="flex items-center gap-2 text-sm"><input id="mra" type="checkbox" class="scale-110"> On MRA (if DM)</label>
        </div>
      </div>
    </section>

    <!-- Summary cards -->
    <section class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
      <div class="card rounded-xl p-4 text-center border">
        <div class="text-xs uppercase tracking-wide muted">eGFR</div>
        <div id="egfr" class="text-3xl font-bold">—</div>
        <div id="egfrStage" class="text-sm mt-1">—</div>
      </div>
      <div class="card rounded-xl p-4 text-center border">
        <div class="text-xs uppercase tracking-wide muted">KFRE 2-yr</div>
        <div id="kfre2" class="text-3xl font-bold">—</div>
        <div id="kfre2Cat" class="text-sm mt-1">—</div>
      </div>
      <div class="card rounded-xl p-4 text-center border">
        <div class="text-xs uppercase tracking-wide muted">KFRE 5-yr</div>
        <div id="kfre5" class="text-3xl font-bold">—</div>
        <div id="kfre5Cat" class="text-sm mt-1">—</div>
      </div>
      <div class="card rounded-xl p-4 text-center border">
        <div class="text-xs uppercase tracking-wide muted">10-yr CVD</div>
        <div id="cvd10" class="text-3xl font-bold">—</div>
        <div id="cvdCat" class="text-sm mt-1">—</div>
      </div>
      <div class="card rounded-xl p-4 text-center border">
        <div class="text-xs uppercase tracking-wide muted">5-yr CKD risk</div>
        <div id="ckd5" class="text-3xl font-bold">—</div>
        <div id="ckd5Cat" class="text-sm mt-1">—</div>
      </div>
      <div class="card rounded-xl p-4 text-center border">
        <div class="text-xs uppercase tracking-wide muted">CKM stage</div>
        <div id="ckm" class="text-3xl font-bold">—</div>
        <div id="ckmDesc" class="text-sm mt-1">—</div>
      </div>
    </section>

    <!-- Charts -->
    <section class="grid lg:grid-cols-2 gap-6">
      <div class="card rounded-2xl shadow-sm p-5">
        <h3 class="font-semibold mb-3">Kidney function projection (eGFR)</h3>
        <canvas id="egfrChart" height="280"></canvas>
      </div>
      <div class="card rounded-2xl shadow-sm p-5">
        <h3 class="font-semibold mb-3">CVD risk projection (10-yr PREVENT)</h3>
        <canvas id="cvdChart" height="280"></canvas>
      </div>
    </section>

    <!-- Simulation -->
    <section class="card rounded-2xl shadow-sm p-5">
      <h3 class="font-semibold mb-2">Simulate treatment impact</h3>
      <p class="muted text-sm mb-4">Toggle interventions to see the “Simulated Path” in both charts.</p>
      <div class="grid sm:grid-cols-3 md:grid-cols-6 gap-3">
        <label class="flex items-center gap-2 text-sm"><input id="sim_stopSmoke" type="checkbox" class="scale-110"> Stop smoking</label>
        <label class="flex items-center gap-2 text-sm"><input id="sim_bp" type="checkbox" class="scale-110"> Control BP (&lt;130)</label>
        <label class="flex items-center gap-2 text-sm"><input id="sim_a1c" type="checkbox" class="scale-110"> A1c &le; 7%</label>
        <label class="flex items-center gap-2 text-sm"><input id="sim_statin" type="checkbox" class="scale-110"> Add statin</label>
        <label class="flex items-center gap-2 text-sm"><input id="sim_sglt2" type="checkbox" class="scale-110"> Add SGLT2i</label>
        <label class="flex items-center gap-2 text-sm"><input id="sim_mra" type="checkbox" class="scale-110"> Add MRA</label>
      </div>
    </section>

    <!-- Interpretation -->
    <section class="card rounded-2xl shadow-sm p-5">
      <h3 class="font-semibold mb-2">What this means</h3>
      <p id="interp" class="text-sm leading-6"></p>
    </section>

    <footer class="muted text-xs text-center py-6">
      Educational only. Uses CKD-EPI (creatinine) for eGFR, PREVENT for CVD, and KFRE (2- &amp; 5-yr) with your spreadsheet’s modifiers for BP control and ACEi/ARB when provided.
    </footer>
  </main>

  <script>
    /* ========= Theme ========= */
    const themeBtn = document.getElementById('themeBtn');
    function setTheme(next) {
      const html = document.documentElement;
      html.classList.toggle('dark', next === 'dark');
      html.classList.toggle('light', next === 'light');
      themeBtn.textContent = next === 'dark' ? 'Dark' : 'Light';
    }
    themeBtn.addEventListener('click', () => {
      const dark = document.documentElement.classList.contains('dark');
      setTheme(dark ? 'light' : 'dark');
    });

    /* ========= DOM ========= */
    const el = id => document.getElementById(id);
    const inputs = {
      age: el('age'), sex: el('sex'), population: el('population'),
      height: el('height'), weight: el('weight'),
      scr: el('scr'), uacr: el('uacr'), sbp: el('sbp'),
      diabetes: el('diabetes'), hypertension: el('hypertension'),
      dyslipidemia: el('dyslipidemia'), smoker: el('smoker'),
      bpControlled: el('bpControlled'), acei: el('acei'),
      sglt2i: el('sglt2i'), mra: el('mra'),
      sim_stopSmoke: el('sim_stopSmoke'), sim_bp: el('sim_bp'),
      sim_a1c: el('sim_a1c'), sim_statin: el('sim_statin'),
      sim_sglt2: el('sim_sglt2'), sim_mra: el('sim_mra')
    };
    const out = {
      ageVal: el('ageVal'), htVal: el('htVal'), wtVal: el('wtVal'),
      scrVal: el('scrVal'), uacrVal: el('uacrVal'), sbpVal: el('sbpVal'),
      bmi: el('bmi'), bmiCat: el('bmiCat'), egfr: el('egfr'),
      egfrStage: el('egfrStage'), kfre2: el('kfre2'), kfre5: el('kfre5'),
      kfre2Cat: el('kfre2Cat'), kfre5Cat: el('kfre5Cat'),
      cvd10: el('cvd10'), cvdCat: el('cvdCat'),
      ckd5: el('ckd5'), ckd5Cat: el('ckd5Cat'),
      ckm: el('ckm'), ckmDesc: el('ckmDesc'),
      interp: el('interp')
    };

    /* ========= Calculations ========= */

    // CKD-EPI 2021 (creatinine) without race; with optional Asian display adjustment x1.1 from your earlier UI
    function calcCKDEPI(age, sex, scr, pop) {
      const k = sex === 'female' ? 0.7 : 0.9;
      const a = sex === 'female' ? -0.241 : -0.302;
      const sexFac = sex === 'female' ? 1.012 : 1.0;
      let egfr = 142 * Math.pow(Math.min(scr/k, 1), a) * Math.pow(Math.max(scr/k, 1), -1.2) * Math.pow(0.9938, age) * sexFac;
      if (pop === 'asian') egfr *= 1.1; // matches your previous control
      return Math.max(0, Math.round(egfr));
    }
    function egfrStage(e) {
      if (e>=90) return 'G1 (Normal)';
      if (e>=60) return 'G2';
      if (e>=45) return 'G3a';
      if (e>=30) return 'G3b';
      if (e>=15) return 'G4';
      return 'G5 (Kidney Failure)';
    }
    function bmiCat(bmi, pop) {
      const asian = pop==='asian';
      if (bmi<18.5) return 'Underweight';
      if (bmi<(asian?23:25)) return 'Normal';
      if (bmi<(asian?27.5:30)) return 'Overweight';
      return 'Obese';
    }

    // ---- KFRE (EXACT per your spreadsheet) ----
    // Spreadsheet linear predictor:
    // LP = (-0.2218*(age/10 - 7.036))
    //    + (0.2553*(male-0.5642))
    //    - (0.5541*(eGFR/5 - 7.222))
    //    + (0.4562*(ln(UACR) - 5.137))
    //    - 0.1475*(BPcontrol - 0.5106)
    //    + 0.1426*(ACEiARB - 0.8501)
    // KFRE 2y  = 100*(1 - 0.983 ^ exp(LP))
    // KFRE 5y  = 100*(1 - 0.937 ^ exp(LP))
    function kfreLinear(age, sex, egfr, uacr, bpControl, aceiArb) {
      const male = sex === 'male' ? 1 : 0;
      const safeU = Math.max(0.1, uacr);
      const lp =
        (-0.2218 * (age/10 - 7.036)) +
        ( 0.2553 * (male - 0.5642)) +
        (-0.5541 * (egfr/5 - 7.222)) +
        ( 0.4562 * (Math.log(safeU) - 5.137)) +
        (-0.1475 * ((bpControl?1:0) - 0.5106)) +
        ( 0.1426 * ((aceiArb?1:0)  - 0.8501));
      return lp;
    }
    function kfre2y(lp){ return 100*(1 - Math.pow(0.983, Math.exp(lp))); }
    function kfre5y(lp){ return 100*(1 - Math.pow(0.937, Math.exp(lp))); }

    // ---- Kawasoe 5-yr CKD risk (logistic, interactive with eGFR & risk factors) ----
    function kawasoe5y(age, sex, eGFR, diabetes, htn, dyslipidemia, hyperuricemia) {
      const sexBin = sex==='male'?1:0;
      const lp = -9.4876 + (0.031*age) + (0.240*sexBin) + (0.347*(htn?1:0)) + (0.089*(dyslipidemia?1:0)) +
                 (0.344*(diabetes?1:0)) + (0.083*(hyperuricemia?1:0)) - (0.198*eGFR/10); // eGFR term scaled to keep range reasonable
      const p = 1/(1+Math.exp(-lp));
      return 100*p;
    }

    // ---- PREVENT 10-yr CVD (condensed implementation – same structure you had) ----
    function prevent10(params) {
      const age_term = (params.age - 55)/10;
      const nonHDL_mmol = (params.totalChol - params.hdl) * 0.02586;
      const hdl_mmol = params.hdl * 0.02586;
      const nonHDL_term = nonHDL_mmol - 3.5;
      const hdl_term = (hdl_mmol - 1.3)/0.3;
      const sbp_min = (Math.min(params.sbp,110)-110)/20;
      const sbp_max = (Math.max(params.sbp,110)-130)/20;
      const diabetes = params.diabetes?1:0;
      const smoker = params.smoker?1:0;
      const egfr_min = (Math.min(params.eGFR,60)-60)/-15;
      const egfr_max = (Math.max(params.eGFR,60)-90)/-15;
      const htn_meds = params.acei?1:0;
      const statin = params.statin?1:0;
      let lo=0;
      if(params.sex==='female'){
        lo = -3.307728 + 0.7939329*age_term + 0.0305239*nonHDL_term -0.1606857*hdl_term
           -0.2394003*sbp_min + 0.360078*sbp_max + 0.8667604*diabetes + 0.5360739*smoker
           +0.6045917*egfr_min +0.0433769*egfr_max +0.3151672*htn_meds -0.1477655*statin
           -0.0663612*htn_meds*sbp_max +0.1197879*statin*nonHDL_term -0.0819715*age_term*nonHDL_term
           +0.0306769*age_term*hdl_term -0.0946348*age_term*sbp_max -0.27057*age_term*diabetes
           -0.078715*age_term*smoker -0.1637806*age_term*egfr_min;
      } else {
        lo = -3.031168 + 0.7688528*age_term + 0.0736174*nonHDL_term -0.0954431*hdl_term
           -0.4347345*sbp_min + 0.3362658*sbp_max + 0.7692857*diabetes + 0.4386871*smoker
           +0.5378979*egfr_min +0.0164827*egfr_max +0.288879*htn_meds -0.1337349*statin
           -0.0475924*htn_meds*sbp_max +0.150273*statin*nonHDL_term -0.0517874*age_term*nonHDL_term
           +0.0191169*age_term*hdl_term -0.1049477*age_term*sbp_max -0.2251948*age_term*diabetes
           -0.0895067*age_term*smoker -0.1543702*age_term*egfr_min;
      }
      const r = Math.exp(lo)/(1+Math.exp(lo));
      return 100*r;
    }

    /* ========= Charts ========= */
    const years = Array.from({length:11},(_,i)=>i);
    const egfrChart = new Chart(document.getElementById('egfrChart'),{
      type:'line',
      data:{labels:years, datasets:[
        {label:'Current', data:[], borderColor:'rgb(239,68,68)', backgroundColor:'rgba(239,68,68,0.1)', borderWidth:3, tension:0.15, pointRadius:0},
        {label:'Simulated', data:[], borderColor:'rgb(59,130,246)', backgroundColor:'rgba(59,130,246,0.1)', borderWidth:3, borderDash:[6,4], tension:0.15, pointRadius:0},
        {label:'Optimal', data:[], borderColor:'rgb(34,197,94)', backgroundColor:'rgba(34,197,94,0.1)', borderWidth:3, tension:0.15, pointRadius:0}
      ]},
      options:{responsive:true, scales:{y:{min:0,max:120,title:{display:true,text:'eGFR (mL/min/1.73m²)'}}, x:{title:{display:true,text:'Years from today'}}},
               plugins:{legend:{display:false}}}
    });
    const cvdChart = new Chart(document.getElementById('cvdChart'),{
      type:'line',
      data:{labels:years, datasets:[
        {label:'Current', data:[], borderColor:'rgb(239,68,68)', backgroundColor:'rgba(239,68,68,0.1)', borderWidth:3, tension:0.15, pointRadius:0},
        {label:'Simulated', data:[], borderColor:'rgb(59,130,246)', backgroundColor:'rgba(59,130,246,0.1)', borderWidth:3, borderDash:[6,4], tension:0.15, pointRadius:0},
        {label:'Optimal', data:[], borderColor:'rgb(34,197,94)', backgroundColor:'rgba(34,197,94,0.1)', borderWidth:3, tension:0.15, pointRadius:0}
      ]},
      options:{responsive:true, scales:{y:{min:0,max:100,title:{display:true,text:'10-yr CVD risk (%)'}}, x:{title:{display:true,text:'Years from today'}}},
               plugins:{legend:{display:false}}}
    });

    /* ========= Projections ========= */
    function egfrDeclinePerYear(params, isOptimal=false){
      // base age-related decline
      let d = 0.7;
      if (params.smoker) d += 0.8;
      d += Math.max(0, params.sbp-130)/10*0.3;
      if (params.diabetes && params.hba1c>7) d += 0.5*(params.hba1c-7);
      const bmiThr = params.population==='asian'?23:25;
      d += Math.max(0, params.bmi-bmiThr)/5*0.2;
      d += Math.max(0, params.uricAcid-7)/1*0.2;
      if (params.acei) d -= 0.5;
      if (params.sglt2i) d -= 1.2;
      if (params.mra && params.diabetes) d -= 0.4;
      if (isOptimal) d -= 0.6; // small additional benefit
      return Math.max(0.2, d);
    }
    function projectEGFR(start, params, isOptimal=false){
      const arr=[start];
      let cur=start;
      const per=egfrDeclinePerYear(params,isOptimal);
      for(let i=1;i<=10;i++){ cur=Math.max(0, cur-per); arr.push(+cur.toFixed(1)); }
      return arr;
    }
    function projectCVD(params, egfrPath){
      const arr=[];
      for(let i=0;i<egfrPath.length;i++){
        const p = {...params, age: params.age+i, eGFR: egfrPath[i]};
        arr.push(+prevent10(p).toFixed(1));
      }
      return arr;
    }

    /* ========= Update ========= */
    function update() {
      // show raw values
      out.ageVal.textContent = inputs.age.value;
      out.htVal.textContent  = inputs.height.value;
      out.wtVal.textContent  = inputs.weight.value;
      out.scrVal.textContent = (+inputs.scr.value).toFixed(2);
      out.uacrVal.textContent = inputs.uacr.value;
      out.sbpVal.textContent = inputs.sbp.value;

      // BMI
      const hM = inputs.height.value/100;
      const bmi = +(inputs.weight.value/(hM*hM)).toFixed(1);
      out.bmi.textContent = bmi.toFixed(1);
      out.bmiCat.textContent = bmiCat(bmi, inputs.population.value);

      // eGFR
      const eGFR = calcCKDEPI(+inputs.age.value, inputs.sex.value, +inputs.scr.value, inputs.population.value);
      out.egfr.textContent = eGFR;
      out.egfrStage.textContent = egfrStage(eGFR);

      // KFRE exact (interactive with BP control + ACEi/ARB flags as in your sheet)
      const lp = kfreLinear(+inputs.age.value, inputs.sex.value, eGFR, +inputs.uacr.value, inputs.bpControlled.checked, inputs.acei.checked);
      const k2 = Math.max(0, Math.min(100, kfre2y(lp)));
      const k5 = Math.max(0, Math.min(100, kfre5y(lp)));
      out.kfre2.textContent = k2.toFixed(1) + '%';
      out.kfre5.textContent = k5.toFixed(1) + '%';
      out.kfre2Cat.textContent = k2<2?'Low':k2<5?'Intermediate':k2<15?'High':'Very High';
      out.kfre5Cat.textContent = k5<2?'Low':k5<5?'Intermediate':k5<15?'High':'Very High';

      // 5-yr CKD incidence (interactive)
      const hyperu = false; // could be fed from a uric-acid slider if you add one
      const ckd5 = Math.max(0, Math.min(100, kawasoe5y(+inputs.age.value, inputs.sex.value, eGFR, inputs.diabetes.checked, inputs.hypertension.checked, inputs.dyslipidemia.checked, hyperu)));
      out.ckd5.textContent = ckd5.toFixed(1) + '%';
      out.ckd5Cat.textContent = ckd5<1?'Low':ckd5<10?'Moderate':ckd5<25?'High':'Very High';

      // PREVENT current
      const preventParams = {
        age:+inputs.age.value, sex:inputs.sex.value, sbp:+inputs.sbp.value,
        totalChol: 220, hdl: 45, // hold constant; change if you add sliders
        diabetes: inputs.diabetes.checked, smoker: inputs.smoker.checked,
        eGFR: eGFR, acei: inputs.acei.checked, statin: false
      };
      const cvdNow = Math.max(0, Math.min(100, prevent10(preventParams)));
      out.cvd10.textContent = cvdNow.toFixed(1) + '%';
      out.cvdCat.textContent = cvdNow<5?'Low':cvdNow<10?'Borderline':cvdNow<20?'Intermediate':'High';

      // CKM (simplified)
      const ckm = (cvdNow>=20||eGFR<30)?['4a','High CV risk']
               : (cvdNow>=10||eGFR<45)?['3b','Adv. kidney/CV risk']
               : (eGFR<60||+inputs.uacr.value>=30)?['3a','Mod. kidney/CV risk']
               : (inputs.sbp.value>=130||inputs.diabetes.checked)?['2','Metabolic risk'] : ['0','Ideal'];
      out.ckm.textContent = ckm[0];
      out.ckmDesc.textContent = ckm[1];

      // Build baseline param object for projections
      const base = {
        age:+inputs.age.value, sex:inputs.sex.value,
        population: inputs.population.value,
        sbp:+inputs.sbp.value, diabetes: inputs.diabetes.checked,
        smoker: inputs.smoker.checked, bmi:bmi, hba1c: inputs.diabetes.checked?8.0:5.6,
        uricAcid: 6.8, acei: inputs.acei.checked, sglt2i: inputs.sglt2i.checked, mra: inputs.mra.checked
      };

      // Simulated and optimal params
      const sim = {...base};
      if (inputs.sim_stopSmoke.checked) sim.smoker=false;
      if (inputs.sim_bp.checked) sim.sbp=125;
      if (inputs.sim_a1c.checked) sim.hba1c=6.8;
      if (inputs.sim_statin.checked) preventParams.statin=true;
      if (inputs.sim_sglt2.checked) sim.sglt2i=true;
      if (inputs.sim_mra.checked) sim.mra=true;

      const opt = {...base, smoker:false, sbp:125, hba1c:6.8, bmi:(inputs.population.value==='asian'?23:25),
                   acei:true, sglt2i:true, mra: base.diabetes };

      // Projections
      const egfrCur = projectEGFR(eGFR, base, false);
      const egfrSim = projectEGFR(eGFR, sim, false);
      const egfrOpt = projectEGFR(eGFR, opt, true);
      egfrChart.data.datasets[0].data = egfrCur;
      egfrChart.data.datasets[1].data = egfrSim;
      egfrChart.data.datasets[2].data = egfrOpt;
      egfrChart.update();

      const cvdCur = projectCVD({...preventParams}, egfrCur);
      const cvdSim = projectCVD({...preventParams, sbp:sim.sbp, smoker:sim.smoker, eGFR:eGFR}, egfrSim);
      const cvdOpt = projectCVD({...preventParams, sbp:125, smoker:false, statin:true}, egfrOpt);
      cvdChart.data.datasets[0].data = cvdCur;
      cvdChart.data.datasets[1].data = cvdSim;
      cvdChart.data.datasets[2].data = cvdOpt;
      cvdChart.update();

      // Narrative
      out.interp.innerHTML =
        `eGFR <b>${eGFR}</b> (${egfrStage(eGFR)}). KFRE shows <b>${k2.toFixed(1)}%</b> 2-yr and <b>${k5.toFixed(1)}%</b> 5-yr kidney failure risk`+
        ` (interactive with BP control and ACEi/ARB as per your spreadsheet). `+
        `Current 10-yr CVD risk is <b>${cvdNow.toFixed(1)}%</b>. `+
        `Use the simulation toggles to visualise trajectory changes.`;
    }

    // Bind events
    Object.values(inputs).forEach(i=>{
      i.addEventListener('input', update);
      i.addEventListener('change', update);
    });

    // Patient presets
    el('pickArjun').addEventListener('click', ()=>{
      inputs.age.value=35; inputs.sex.value='male'; inputs.population.value='asian';
      inputs.height.value=178; inputs.weight.value=76; inputs.scr.value=1.05; inputs.uacr.value=20; inputs.sbp.value=128;
      inputs.diabetes.checked=false; inputs.hypertension.checked=true; inputs.dyslipidemia.checked=false; inputs.smoker.checked=false;
      inputs.bpControlled.checked=true; inputs.acei.checked=true; inputs.sglt2i.checked=false; inputs.mra.checked=false;
      update();
    });
    el('pickMeera').addEventListener('click', ()=>{
      inputs.age.value=41; inputs.sex.value='female'; inputs.population.value='asian';
      inputs.height.value=162; inputs.weight.value=84; inputs.scr.value=1.00; inputs.uacr.value=250; inputs.sbp.value=146;
      inputs.diabetes.checked=true; inputs.hypertension.checked=true; inputs.dyslipidemia.checked=true; inputs.smoker.checked=false;
      inputs.bpControlled.checked=false; inputs.acei.checked=false; inputs.sglt2i.checked=false; inputs.mra.checked=false;
      update();
    });

    // Initial render
    update();
  </script>
</body>
</html>
