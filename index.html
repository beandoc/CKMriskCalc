<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cardiorenal Journey — Patient Stories (India)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --card-radius: 16px;
  }
  .card { border-radius: var(--card-radius); }
  /* Compact sliders */
  input[type="range"] { accent-color: #60a5fa }
  /* Toggle pill */
  .switch { position: relative; display:inline-block; width:44px;height:26px}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;cursor:pointer;inset:0;background:#374151;transition:.2s;border-radius:9999px}
  .slider:before{content:"";position:absolute;height:20px;width:20px;left:3px;top:3px;background:white;border-radius:9999px;transition:.2s}
  .switch input:checked + .slider{background:#10b981}
  .switch input:checked + .slider:before{transform:translateX(18px)}
  /* Collapse panel for inactive profile */
  .collapse { max-height: 0; overflow: hidden; transition: max-height .25s ease; }
  .collapse.open { max-height: 1200px; }
  /* Mobile tweaks for tight spacing */
  @media (max-width: 640px){
    .kpi { min-width: 46%; }
  }
</style>
</head>
<body class="bg-[#0b1220] text-slate-100">
  <!-- Header / Theme -->
  <header class="sticky top-0 z-10 backdrop-blur bg-[#0b1220]/70 border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div>
        <h1 class="text-xl sm:text-2xl font-semibold">Cardiorenal Journey — Patient Stories</h1>
        <p class="text-slate-400 text-sm">Select a hypothetical patient, review risks, and simulate treatment impact.</p>
      </div>
      <div class="flex items-center space-x-3">
        <span class="text-sm text-slate-400">Theme</span>
        <label class="switch">
          <input id="themeToggle" type="checkbox" />
          <span class="slider"></span>
        </label>
        <span id="themeLabel" class="text-sm">Dark</span>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-3 sm:px-4 py-4 space-y-4">
    <!-- Row: Profiles + Inputs -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- Profiles -->
      <div class="card bg-slate-900 border border-slate-800 p-4">
        <h2 class="text-lg font-semibold mb-2">Select a hypothetical patient</h2>
        <p class="text-slate-400 text-sm mb-4">Tap a profile to pre-fill inputs. You can edit anything afterwards.</p>

        <div class="grid grid-cols-2 gap-3">
          <!-- Arjun -->
          <button id="pickArjun"
                  class="group relative p-3 rounded-xl border text-left transition
                         border-slate-700 bg-slate-800/60 hover:bg-slate-800 focus:ring-2 ring-blue-400">
            <div class="flex items-center gap-3">
              <div class="flex items-center justify-center h-10 w-10 rounded-full bg-blue-600/20 text-blue-300 font-semibold">A</div>
              <div>
                <div class="flex items-center gap-2">
                  <h3 class="font-semibold">Arjun <span class="text-slate-400 text-sm">(35)</span></h3>
                  <span class="px-1.5 py-0.5 text-[10px] rounded bg-blue-500/20 text-blue-300">Male</span>
                </div>
                <p class="text-[12px] text-slate-400 leading-snug">IT engineer, Pune</p>
              </div>
            </div>
            <p id="arjunBlurb" class="mt-2 text-sm text-slate-300 leading-snug"></p>
          </button>

          <!-- Meera -->
          <button id="pickMeera"
                  class="group relative p-3 rounded-xl border text-left transition
                         border-slate-700 bg-slate-800/60 hover:bg-slate-800 focus:ring-2 ring-rose-400">
            <div class="flex items-center gap-3">
              <div class="flex items-center justify-center h-10 w-10 rounded-full bg-rose-600/20 text-rose-300 font-semibold">M</div>
              <div>
                <div class="flex items-center gap-2">
                  <h3 class="font-semibold">Meera <span class="text-slate-400 text-sm">(41)</span></h3>
                  <span class="px-1.5 py-0.5 text-[10px] rounded bg-rose-500/20 text-rose-300">Female</span>
                </div>
                <p class="text-[12px] text-slate-400 leading-snug">School teacher, Pune</p>
              </div>
            </div>
            <p id="meeraBlurb" class="mt-2 text-sm text-slate-300 leading-snug"></p>
          </button>
        </div>

        <!-- Active profile text -->
        <div class="mt-4 space-y-2">
          <div class="text-xs uppercase text-slate-400 tracking-wide">Active profile</div>
          <div id="activeProfileCard" class="bg-slate-800/70 border border-slate-700 rounded-xl p-3">
            <div class="flex items-center justify-between">
              <div class="font-semibold" id="activeName">Arjun</div>
              <div class="text-xs text-slate-400" id="activeMeta"></div>
            </div>
            <p id="activeStory" class="mt-2 text-sm text-slate-200"></p>
          </div>
          <!-- Collapsible inactive profile -->
          <div id="inactivePanel" class="collapse">
            <div class="bg-slate-800/40 border border-slate-700 rounded-xl p-3 mt-2">
              <div class="text-xs uppercase text-slate-400 tracking-wide mb-1">Collapsed profile</div>
              <p id="inactiveStory" class="text-sm text-slate-300"></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Inputs -->
      <div class="lg:col-span-2 card bg-slate-900 border border-slate-800 p-4">
        <h2 class="text-lg font-semibold mb-2">Clinical inputs</h2>
        <p class="text-slate-400 text-xs mb-3">These drive eGFR (CKD-EPI 2021), KFRE (2 & 5 yr), CVD risk (displayed), and CKM stage.</p>

        <!-- Compact, two-row responsive inputs -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <!-- Col A -->
          <div class="space-y-3">
            <div>
              <div class="flex justify-between text-sm"><label>Age</label><span id="ageOut" class="text-slate-300">40 yrs</span></div>
              <input id="age" type="range" min="30" max="80" value="40" />
            </div>

            <div class="grid grid-cols-2 gap-2">
              <div>
                <div class="flex justify-between text-sm"><label>Height</label><span id="htOut">170 cm</span></div>
                <input id="height" type="range" min="140" max="200" value="170" />
              </div>
              <div>
                <div class="flex justify-between text-sm"><label>Weight</label><span id="wtOut">72 kg</span></div>
                <input id="weight" type="range" min="40" max="140" value="72" />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="text-sm">Sex</label>
                <select id="sex" class="w-full bg-slate-800 border border-slate-700 rounded-md p-2">
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
              </div>
              <div>
                <label class="text-sm">Population (BMI thresholds)</label>
                <select id="population" class="w-full bg-slate-800 border border-slate-700 rounded-md p-2">
                  <option value="asian">South/East Asian</option>
                  <option value="general">General</option>
                </select>
              </div>
            </div>

            <div class="flex flex-wrap gap-4 text-sm">
              <label class="inline-flex items-center gap-2"><input id="diabetes" type="checkbox" class="accent-emerald-400">Diabetes</label>
              <label class="inline-flex items-center gap-2"><input id="hypertension" type="checkbox" class="accent-emerald-400">Hypertension</label>
              <label class="inline-flex items-center gap-2"><input id="dyslipidemia" type="checkbox" class="accent-emerald-400">Dyslipidaemia</label>
              <label class="inline-flex items-center gap-2"><input id="smoker" type="checkbox" class="accent-emerald-400">Current smoker</label>
            </div>

            <div class="flex flex-wrap gap-4 text-sm">
              <label class="inline-flex items-center gap-2"><input id="onACEi" type="checkbox" class="accent-sky-400">On ACEi/ARB</label>
              <label class="inline-flex items-center gap-2"><input id="onSGLT2i" type="checkbox" class="accent-sky-400">On SGLT2i</label>
              <label class="inline-flex items-center gap-2"><input id="onStatin" type="checkbox" class="accent-sky-400">On statin</label>
              <label class="inline-flex items-center gap-2"><input id="onMRA" type="checkbox" class="accent-sky-400">On MRA (if DM)</label>
              <label class="inline-flex items-center gap-2"><input id="bpControlled" type="checkbox" class="accent-sky-400">BP controlled (&lt;130)</label>
            </div>
          </div>

          <!-- Col B -->
          <div class="space-y-3">
            <div>
              <div class="flex justify-between text-sm"><label>Serum creatinine</label><span id="scrOut">1.00 mg/dL</span></div>
              <input id="creatinine" type="range" min="0.4" max="5.0" step="0.01" value="1.00" />
            </div>
            <div>
              <div class="flex justify-between text-sm"><label>UACR</label><span id="uacrOut">80 mg/g</span></div>
              <input id="uacr" type="range" min="5" max="1200" step="5" value="80" />
            </div>
            <div>
              <div class="flex justify-between text-sm"><label>SBP</label><span id="sbpOut">138 mmHg</span></div>
              <input id="sbp" type="range" min="90" max="200" step="1" value="138" />
            </div>
            <div>
              <div class="flex justify-between text-sm"><label>HDL</label><span id="hdlOut">43 mg/dL</span></div>
              <input id="hdl" type="range" min="20" max="100" step="1" value="43" />
            </div>
            <div>
              <div class="flex justify-between text-sm"><label>Total cholesterol</label><span id="tcOut">190 mg/dL</span></div>
              <input id="totalChol" type="range" min="120" max="300" step="1" value="190" />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
      <div class="kpi card bg-slate-900 border border-slate-800 p-3">
        <div class="text-[11px] uppercase text-slate-400">eGFR</div>
        <div id="egfrOut" class="text-3xl font-bold">—</div>
        <div id="egfrStageOut" class="text-sm text-slate-400">—</div>
      </div>
      <div class="kpi card bg-slate-900 border border-slate-800 p-3">
        <div class="text-[11px] uppercase text-slate-400">KFRE 2-YR</div>
        <div id="kfre2Out" class="text-3xl font-bold">—</div>
        <div id="kfre2Cat" class="text-sm text-slate-400">—</div>
      </div>
      <div class="kpi card bg-slate-900 border border-slate-800 p-3">
        <div class="text-[11px] uppercase text-slate-400">KFRE 5-YR</div>
        <div id="kfre5Out" class="text-3xl font-bold">—</div>
        <div id="kfre5Cat" class="text-sm text-slate-400">—</div>
      </div>
      <div class="kpi card bg-slate-900 border border-slate-800 p-3">
        <div class="text-[11px] uppercase text-slate-400">10-YR CVD</div>
        <div id="cvdOut" class="text-3xl font-bold">—</div>
        <div id="cvdCat" class="text-sm text-slate-400">—</div>
      </div>
      <div class="kpi card bg-slate-900 border border-slate-800 p-3">
        <div class="text-[11px] uppercase text-slate-400">BMI</div>
        <div id="bmiOut" class="text-3xl font-bold">—</div>
        <div id="bmiCat" class="text-sm text-slate-400">—</div>
      </div>
      <div class="kpi card bg-slate-900 border border-slate-800 p-3">
        <div class="text-[11px] uppercase text-slate-400">CKM STAGE</div>
        <div id="ckmOut" class="text-3xl font-bold">—</div>
        <div id="ckmCat" class="text-sm text-slate-400">—</div>
      </div>
    </section>

    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="card bg-slate-900 border border-slate-800 p-3">
        <h3 class="font-semibold mb-2">Kidney function projection (eGFR)</h3>
        <canvas id="egfrChart" height="240"></canvas>
        <p class="text-xs text-slate-400 mt-2">Lines: current (red), simulated (blue), optimal (green).</p>
      </div>
      <div class="card bg-slate-900 border border-slate-800 p-3">
        <h3 class="font-semibold mb-2">CVD risk projection (10-yr, displayed model)</h3>
        <canvas id="cvdChart" height="240"></canvas>
        <p class="text-xs text-slate-400 mt-2">Shows effect of smoking, SBP, statin on 10-yr risk.</p>
      </div>
    </section>

    <!-- Disclaimer -->
    <section class="text-xs text-slate-400 px-1">
      Educational simulation only. eGFR via CKD-EPI 2021; KFRE via Tangri 4-variable centered form (2- &amp; 5-yr). Projections are illustrative.
    </section>
  </main>

<script>
/* -------------------- Utilities & State -------------------- */
const els = (ids)=>Object.fromEntries(ids.map(id=>[id,document.getElementById(id)]));

const E = els([
  "pickArjun","pickMeera","activeName","activeMeta","activeStory","inactivePanel","inactiveStory",
  "arjunBlurb","meeraBlurb","themeToggle","themeLabel",
  "age","height","weight","sex","population","diabetes","hypertension","dyslipidemia","smoker",
  "onACEi","onSGLT2i","onStatin","onMRA","bpControlled",
  "creatinine","uacr","sbp","hdl","totalChol",
  "ageOut","htOut","wtOut","scrOut","uacrOut","sbpOut","hdlOut","tcOut",
  "egfrOut","egfrStageOut","kfre2Out","kfre5Out","kfre2Cat","kfre5Cat",
  "cvdOut","cvdCat","bmiOut","bmiCat","ckmOut","ckmCat"
]);

let activeProfile = "arjun";

/* Default profiles */
const presets = {
  arjun: {
    age: 35, sex: "male", height: 173, weight: 78, creatinine: 1.05, uacr: 25, sbp: 128,
    hdl: 46, totalChol: 182, population: "asian",
    diabetes: false, hypertension: true, dyslipidemia: false, smoker: false,
    onACEi: true, onSGLT2i: false, onStatin: false, onMRA: false, bpControlled: true
  },
  meera: {
    age: 41, sex: "female", height: 162, weight: 84, creatinine: 1.0, uacr: 250, sbp: 146,
    hdl: 42, totalChol: 210, population: "asian",
    diabetes: true, hypertension: true, dyslipidemia: true, smoker: false,
    onACEi: false, onSGLT2i: false, onStatin: false, onMRA: false, bpControlled: false
  }
};

/* -------------------- Clinical Calculations -------------------- */
/* CKD-EPI 2021 (creatinine) — NKF/NEJM */
function egfrCKDEPI2021(age, sex, scr){
  const K = sex === "female" ? 0.7 : 0.9;
  const alpha = sex === "female" ? -0.241 : -0.302;
  const minTerm = Math.min(scr / K, 1);
  const maxTerm = Math.max(scr / K, 1);
  let eGFR = 142 * Math.pow(minTerm, alpha) * Math.pow(maxTerm, -1.200) * Math.pow(0.9938, age);
  if(sex === "female") eGFR *= 1.012;
  return eGFR;
}

/* KFRE 4-variable centered form (matches your Excel constants)
   Risk(t) = 100 * (1 - S0(t) ^ exp(LP))
   LP =  (-0.2218)*(age/10 - 7.036)
       + ( 0.2553)*(male - 0.5642)
       + (-0.5541)*(eGFR/5 - 7.222)
       + ( 0.4562)*(ln(ACR) - 5.137)
   S0(2y)=0.983 ; S0(5y)=0.937
*/
function kfre4(age, sex, eGFR, acr, horizonYears){
  const male = (sex === "male") ? 1 : 0;
  const lp = (-0.2218) * (age/10 - 7.036)
           + ( 0.2553) * (male - 0.5642)
           + (-0.5541) * (eGFR/5 - 7.222)
           + ( 0.4562) * (Math.log(Math.max(acr,1)) - 5.137);
  const S0 = (horizonYears===2) ? 0.983 : 0.937;
  const risk = 100 * (1 - Math.pow(S0, Math.exp(lp)));
  return Math.max(0, Math.min(100, risk));
}

/* BMI */
function bmiKgM2(wt, htCm){const m = htCm/100; return wt/(m*m);}

/* BMI category with Asian cutoffs */
function bmiCategory(bmi, pop){
  const asian = pop==="asian";
  if(bmi < 18.5) return ["Underweight","text-blue-300"];
  if(bmi < (asian?23:25)) return ["Normal","text-emerald-300"];
  if(bmi < (asian?27.5:30)) return ["Overweight","text-amber-300"];
  return ["Obese","text-rose-300"];
}

/* eGFR stage text */
function egfrStage(e){
  if(e>=90) return "G1";
  if(e>=60) return "G2";
  if(e>=45) return "G3a";
  if(e>=30) return "G3b";
  if(e>=15) return "G4";
  return "G5";
}

/* Simple CKM summary (display only) */
function ckmStage(e, acr, cvd10){
  if(e<30 || cvd10>=20) return ["4a","High kidney/CV risk"];
  if(e<45 || acr>=300 || cvd10>=10) return ["3b","Mod–high kidney/CV risk"];
  if(e<60 || acr>=30) return ["3a","Mod. kidney/CV risk"];
  return ["2","Metabolic risk"];
}

/* -------- Projections (illustrative; parameterized) -------- */
/* Annual chronic slope model (mL/min/1.73m² per year).
   Baseline age-related decline ~0.7 after midlife; add penalties;
   subtract protections. */
function egfrAnnualSlope(params){
  const {
    age, eGFR, sbp, uacr, diabetes, smoker,
    onACEi, onSGLT2i, onMRA, bpControlled
  } = params;

  let slope = 0.7;                     // baseline decline
  if (eGFR < 60) slope += 0.3;
  if (uacr >= 30 && uacr < 300) slope += 0.6;
  if (uacr >= 300) slope += 1.0;
  if (diabetes) slope += 0.4;
  if (sbp >= 140 || !bpControlled) slope += 0.5;
  if (smoker) slope += 0.4;

  // Protections (chronic slope improvement — conservative)
  if (onACEi)    slope -= 0.3;
  if (onSGLT2i)  slope -= 1.0;          // slower chronic loss
  if (onMRA && diabetes) slope -= 0.2;

  return Math.max(0.2, slope);
}
function projectEGFR(start, years, p){
  let arr=[Number(start.toFixed(1))], cur=start;
  for(let i=1;i<=years;i++){
    const s = egfrAnnualSlope(p);
    cur = Math.max(0, cur - s);
    arr.push(Number(cur.toFixed(1)));
  }
  return arr;
}

/* CVD risk (displayed).
   For reproducible client-side code without external libs, we show a
   compact *educational* model that moves risk with SBP, smoking,
   statin (RR~0.8), HDL/TC, diabetes. Baseline anchored to PCE-like
   magnitude; treatment toggles reflect relative change. */
function cvdTenYearDisplayRisk(p){
  // Base from common drivers (rough calibration ~ primary prevention mid-risk)
  let base = 2
    + 0.12*(p.age-40)                // age driver
    + 0.02*(p.sbp-120)
    + (p.diabetes?2.0:0)
    + (p.smoker?2.5:0)
    + 0.015*((p.totalChol-p.hdl)-130)
    - 0.02*(p.hdl-45)
    + (p.sex==="male"?1.0:0);

  // Treatments (relative multipliers)
  let rr = 1.0;
  if(p.onStatin) rr *= 0.78;         // statin effect on major events (CTT)
  if(p.bpControlled || p.sbp<130) rr *= 0.88; // SBP control
  if(!p.smoker) rr *= 0.82;          // cessation over years
  // SGLT2i and MRA primarily HF/renal benefits; keep small CV composite effect:
  if(p.onSGLT2i) rr *= 0.95;
  if(p.onMRA && p.diabetes) rr *= 0.96;

  const risk = Math.max(0, Math.min(50, base*rr));
  return risk;
}

/* -------------------- Dynamic Profile Narratives -------------------- */
function buildStory(name, p){
  const bmi = bmiKgM2(p.weight, p.height);
  const [bmiTxt] = bmiCategory(bmi, p.population);
  const city = "Pune";
  const prolog = name==="Arjun"
    ? `${name} is a ${p.age}-year-old non-smoker from ${city}, keen on long-term health.`
    : `${name} is a ${p.age}-year-old from ${city}, balancing work and family.`;
  const risks = [
    p.hypertension ? "high blood pressure" : null,
    p.diabetes ? "type 2 diabetes" : null,
    p.smoker ? "current smoking" : null,
    (p.uacr>=30?"elevated UACR":"")
  ].filter(Boolean).join(", ");
  const riskStr = risks ? ` Key issues: ${risks}.` : "";
  const meds = [
    p.onACEi ? "ACEi/ARB" : null,
    p.onSGLT2i ? "SGLT2i" : null,
    p.onStatin ? "statin" : null,
    (p.onMRA && p.diabetes) ? "MRA" : null
  ].filter(Boolean).join(", ");
  const medStr = meds ? ` On ${meds}.` : "";
  return `${prolog} BMI is ${bmi.toFixed(1)} (${bmiTxt}).${riskStr}${medStr}`;
}

function updateNarratives(p){
  const ar = presets.arjun, me = presets.meera;
  E.arjunBlurb.textContent = buildStory("Arjun", ar);
  E.meeraBlurb.textContent = buildStory("Meera", me);

  const actName = activeProfile==="arjun" ? "Arjun" : "Meera";
  const act = activeProfile==="arjun" ? ar : me;
  const ina = activeProfile==="arjun" ? me : ar;
  E.activeName.textContent = actName;
  E.activeMeta.textContent = `${act.sex==="male"?"Male":"Female"} • ${act.age} yrs`;
  E.activeStory.textContent = buildStory(actName, act);
  E.inactiveStory.textContent = buildStory(activeProfile==="arjun"?"Meera":"Arjun", ina);
  E.inactivePanel.classList.add("open");
}

/* -------------------- Charts -------------------- */
let egfrChart, cvdChart;
function makeCharts(){
  const common = {responsive:true, maintainAspectRatio:false, scales:{x:{},y:{}}};
  const ctx1 = document.getElementById("egfrChart").getContext("2d");
  egfrChart = new Chart(ctx1,{
    type:"line",
    data:{labels:[...Array(11)].map((_,i)=>`Year ${i}`),
      datasets:[
        {label:"Current", data:[], borderColor:"rgb(239,68,68)", backgroundColor:"rgba(239,68,68,.1)", borderWidth:2, tension:.2, pointRadius:0},
        {label:"Simulated", data:[], borderColor:"rgb(59,130,246)", backgroundColor:"rgba(59,130,246,.1)", borderWidth:2, borderDash:[5,5], tension:.2, pointRadius:0},
        {label:"Optimal", data:[], borderColor:"rgb(34,197,94)", backgroundColor:"rgba(34,197,94,.1)", borderWidth:2, tension:.2, pointRadius:0}
      ]},
    options:{...common, scales:{y:{title:{display:true,text:"eGFR (mL/min/1.73m²)"}, min:0, max:120}}});
  const ctx2 = document.getElementById("cvdChart").getContext("2d");
  cvdChart = new Chart(ctx2,{
    type:"line",
    data:{labels:[...Array(11)].map((_,i)=>`Year ${i}`),
      datasets:[
        {label:"Current", data:[], borderColor:"rgb(239,68,68)", backgroundColor:"rgba(239,68,68,.1)", borderWidth:2, tension:.2, pointRadius:0},
        {label:"Simulated", data:[], borderColor:"rgb(59,130,246)", backgroundColor:"rgba(59,130,246,.1)", borderWidth:2, borderDash:[5,5], tension:.2, pointRadius:0},
        {label:"Optimal", data:[], borderColor:"rgb(34,197,94)", backgroundColor:"rgba(34,197,94,.1)", borderWidth:2, tension:.2, pointRadius:0}
      ]},
    options:{...common, scales:{y:{title:{display:true,text:"10-yr risk (%)"}, min:0, max:50}}});
}

/* -------------------- Simulation Update -------------------- */
function readActive(){
  // Build params from UI
  const P = {
    age: +E.age.value,
    height: +E.height.value,
    weight: +E.weight.value,
    sex: E.sex.value,
    population: E.population.value,
    diabetes: E.diabetes.checked,
    hypertension: E.hypertension.checked,
    dyslipidemia: E.dyslipidemia.checked,
    smoker: E.smoker.checked,
    onACEi: E.onACEi.checked,
    onSGLT2i: E.onSGLT2i.checked,
    onStatin: E.onStatin.checked,
    onMRA: E.onMRA.checked,
    bpControlled: E.bpControlled.checked,
    creatinine: +E.creatinine.value,
    uacr: +E.uacr.value,
    sbp: +E.sbp.value,
    hdl: +E.hdl.value,
    totalChol: +E.totalChol.value
  };
  // Mirror to preset (so narratives stay dynamic)
  presets[activeProfile] = {...presets[activeProfile], ...P};
  return P;
}
function reflectUI(p){
  E.ageOut.textContent = `${p.age} yrs`;
  E.htOut.textContent = `${p.height} cm`;
  E.wtOut.textContent = `${p.weight} kg`;
  E.scrOut.textContent = `${p.creatinine.toFixed(2)} mg/dL`;
  E.uacrOut.textContent = `${p.uacr} mg/g`;
  E.sbpOut.textContent = `${p.sbp} mmHg`;
  E.hdlOut.textContent = `${p.hdl} mg/dL`;
  E.tcOut.textContent = `${p.totalChol} mg/dL`;
}

function updateAll(){
  const P = readActive();
  reflectUI(P);

  // eGFR
  const e = egfrCKDEPI2021(P.age, P.sex, P.creatinine);
  const eRounded = Math.round(e);
  E.egfrOut.textContent = eRounded;
  E.egfrStageOut.textContent = egfrStage(eRounded);

  // BMI
  const bmi = bmiKgM2(P.weight, P.height);
  E.bmiOut.textContent = bmi.toFixed(1);
  const [bmiTxt] = bmiCategory(bmi, P.population);
  E.bmiCat.textContent = bmiTxt;

  // KFRE (exact to your Excel form)
  const k2 = kfre4(P.age, P.sex, e, P.uacr, 2);
  const k5 = kfre4(P.age, P.sex, e, P.uacr, 5);
  E.kfre2Out.textContent = `${k2.toFixed(1)}%`;
  E.kfre5Out.textContent = `${k5.toFixed(1)}%`;
  E.kfre2Cat.textContent = k2<2 ? "Low" : k2<5 ? "Intermediate" : k2<15 ? "High" : "Very high";
  E.kfre5Cat.textContent = k5<2 ? "Low" : k5<5 ? "Intermediate" : k5<15 ? "High" : "Very high";

  // CVD (display model)
  const cvd = cvdTenYearDisplayRisk({...P});
  E.cvdOut.textContent = `${cvd.toFixed(1)}%`;
  E.cvdCat.textContent = cvd<5?"Low":cvd<7.5?"Borderline":cvd<20?"Intermediate":"High";

  // CKM
  const [ckmS, ckmT] = ckmStage(e, P.uacr, cvd);
  E.ckmOut.textContent = ckmS;
  E.ckmCat.textContent = ckmT;

  // Narratives (dynamic text)
  updateNarratives(P);

  // Projections
  const labels = [...Array(11)].map((_,i)=>i);
  const currentParams = {...P};
  const simParams     = {...P,
    smoker: P.smoker?false:false,
    sbp: P.sbp>130?130:P.sbp,
    bpControlled: true,
    onACEi: P.onACEi || true,
    onSGLT2i: P.onSGLT2i || (P.diabetes || P.uacr>=30),
    onStatin: P.onStatin || true,
    onMRA: P.onMRA || (P.diabetes)
  };
  const optParams     = {...P,
    smoker:false, sbp:120, bpControlled:true,
    onACEi:true, onSGLT2i:true, onStatin:true, onMRA:!!P.diabetes
  };

  // Recompute baseline eGFR for each (age changes per year)
  function egfrSeries(start, params){
    return projectEGFR(start, 10, params);
  }
  const curE = egfrSeries(e, currentParams);
  const simE = egfrSeries(e, simParams);
  const optE = egfrSeries(e, optParams);

  egfrChart.data.datasets[0].data = curE;
  egfrChart.data.datasets[1].data = simE;
  egfrChart.data.datasets[2].data = optE;
  egfrChart.update();

  // CVD trajectories (age increases + eGFR drift feeds risk minimally here)
  function cvdSeries(baseParams, eSeries){
    const arr=[];
    for(let i=0;i<eSeries.length;i++){
      const p = {...baseParams, age: baseParams.age+i, eGFR: eSeries[i]};
      arr.push(cvdTenYearDisplayRisk(p));
    }
    return arr;
  }
  cvdChart.data.datasets[0].data = cvdSeries(currentParams, curE);
  cvdChart.data.datasets[1].data = cvdSeries(simParams, simE);
  cvdChart.data.datasets[2].data = cvdSeries(optParams, optE);
  cvdChart.update();
}

/* -------------------- Load/Profile/Theme -------------------- */
function loadPreset(name){
  activeProfile = name;
  const p = presets[name];
  // write into UI
  E.age.value=p.age; E.height.value=p.height; E.weight.value=p.weight;
  E.sex.value=p.sex; E.population.value=p.population;
  E.diabetes.checked=p.diabetes; E.hypertension.checked=p.hypertension;
  E.dyslipidemia.checked=p.dyslipidemia; E.smoker.checked=p.smoker;
  E.onACEi.checked=p.onACEi; E.onSGLT2i.checked=p.onSGLT2i;
  E.onStatin.checked=p.onStatin; E.onMRA.checked=p.onMRA; E.bpControlled.checked=p.bpControlled;
  E.creatinine.value=p.creatinine; E.uacr.value=p.uacr; E.sbp.value=p.sbp;
  E.hdl.value=p.hdl; E.totalChol.value=p.totalChol;

  // collapsed inactive
  E.inactivePanel.classList.add("open");
  updateAll();
}

function bindInputs(){
  const all = [
    E.age,E.height,E.weight,E.sex,E.population,E.diabetes,E.hypertension,E.dyslipidemia,E.smoker,
    E.onACEi,E.onSGLT2i,E.onStatin,E.onMRA,E.bpControlled,
    E.creatinine,E.uacr,E.sbp,E.hdl,E.totalChol
  ];
  all.forEach(el=>{ el.addEventListener("input", updateAll); el.addEventListener("change", updateAll); });

  // profile pickers (fixing Meera bug by ensuring event binding + state)
  E.pickArjun.addEventListener("click", ()=>loadPreset("arjun"));
  E.pickMeera.addEventListener("click", ()=>loadPreset("meera"));

  // theme
  const prefersLight = window.matchMedia("(prefers-color-scheme: light)").matches;
  if(prefersLight){ E.themeToggle.checked=true; }
  applyTheme();
  E.themeToggle.addEventListener("change", applyTheme);
}
function applyTheme(){
  const light = E.themeToggle.checked;
  document.body.className = light ? "bg-white text-slate-900" : "bg-[#0b1220] text-slate-100";
  const cards = document.querySelectorAll(".card");
  cards.forEach(c=>{
    c.classList.remove("bg-white","border-slate-200");
    c.classList.remove("bg-slate-900","border-slate-800");
    if(light){ c.classList.add("bg-white","border-slate-200"); }
    else{ c.classList.add("bg-slate-900","border-slate-800"); }
  });
  E.themeLabel.textContent = light ? "Light" : "Dark";
}

/* -------------------- Init -------------------- */
document.addEventListener("DOMContentLoaded", ()=>{
  makeCharts();
  bindInputs();
  loadPreset("arjun"); // default
});
</script>
</body>
</html>
