<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cardiorenal Journey — Patient Stories</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            base: {
              DEFAULT: '#0f172a',   /* slate-900 */
              card: '#111827',      /* gray-900  */
              soft: '#1f2937',      /* gray-800  */
              border: '#243244',
            }
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .card { border-radius: 1rem; border: 1px solid #243244; background: #111827; padding: 1rem; box-shadow: 0 10px 24px rgba(0,0,0,.18) }
    .btn { display:inline-flex; align-items:center; justify-content:center; border-radius:.75rem; padding:.5rem .75rem; border:1px solid #243244; background:#1f2937; color:#fff; font-weight:600 }
    .btn:hover { background:#263445 }
    .btn-tab { width:100%; text-align:left; border-radius:.75rem; border:1px solid #243244; padding: .85rem; background:#111827 }
    .btn-tab:hover { background:#162133 }
    .btn-tab-active { background:#0b1220; outline: 2px solid #3b82f6 }
    .pill { display:flex; align-items:center; gap:.5rem; border-radius:.5rem; border:1px solid #243244; background:#1f2937; padding:.4rem .6rem; font-size:.9rem }
    .labelRow { display:flex; justify-content:space-between; font-size:.75rem; color:#9ca3af; margin-bottom:.25rem }
    .kpi { border-radius: 1rem; border: 1px solid #243244; background:#0b1220; padding:.9rem }
    .kpi .label { font-size:.7rem; text-transform:uppercase; letter-spacing:.06em; color:#9ca3af }
    .kpi .value { font-weight:800; font-size:1.6rem }
    .kpi .sub { font-size:.75rem; color:#9ca3af }
    .hidden-collapsible { height:0; overflow:hidden; opacity:0; transform: translateY(-6px); transition: height .25s ease, opacity .2s ease, transform .2s ease }
    .show-collapsible { height:auto; opacity:1; transform: translateY(0) }

    /* compact spacing on small screens */
    @media (max-width: 640px){
      .grid-tight { gap:.65rem }
      .stack-tight > * + * { margin-top:.5rem }
    }

    /* Light theme overrides */
    .light body { background:#f6f7fb; color:#111827 }
    .light .card { background:#ffffff; border-color:#e5e7eb; box-shadow: 0 10px 24px rgba(0,0,0,.08) }
    .light .btn, .light .pill { background:#f3f4f6; color:#111827; border-color:#e5e7eb }
    .light .btn:hover { background:#e5e7eb }
    .light .btn-tab { background:#ffffff; border-color:#e5e7eb }
    .light .btn-tab:hover { background:#f5f7fb }
    .light .btn-tab-active { background:#eef6ff; outline-color:#3b82f6 }
    .light .kpi { background:#ffffff; border-color:#e5e7eb }
  </style>
</head>

<body class="bg-base text-white antialiased">
  <!-- Header -->
  <header class="sticky top-0 z-20 backdrop-blur bg-base/80 border-b border-base-border">
    <div class="max-w-7xl mx-auto px-3 sm:px-4 py-3 flex items-center gap-3">
      <div class="text-xl md:text-2xl font-extrabold">Cardiorenal Journey — <span class="text-blue-400">Patient Stories</span></div>
      <div class="ml-auto flex items-center gap-2">
        <button id="themeToggle" class="btn" aria-label="Toggle theme">
          <span class="hidden sm:inline">Theme</span>
          <span id="themeState" class="ml-2 text-xs px-2 py-1 rounded-full border border-base-border bg-base-soft">Dark</span>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-3 sm:px-4 py-4 md:py-6">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-6 grid-tight">
      <!-- Left pane -->
      <section class="lg:col-span-4 space-y-4 stack-tight">
        <div class="card">
          <h2 class="text-base sm:text-lg font-semibold mb-3">Select a hypothetical patient</h2>
          <div class="grid grid-cols-2 gap-2">
            <button id="cardArjun" class="btn-tab btn-tab-active" aria-pressed="true">
              <div class="flex items-center gap-3">
                <div class="grid place-items-center w-9 h-9 rounded-full bg-blue-600 font-bold">A</div>
                <div>
                  <div class="font-semibold leading-5">Arjun (35)</div>
                  <div class="text-[11px] text-gray-400">IT engineer, Pune</div>
                </div>
              </div>
            </button>
            <button id="cardMeera" class="btn-tab" aria-pressed="false">
              <div class="flex items-center gap-3">
                <div class="grid place-items-center w-9 h-9 rounded-full bg-pink-600 font-bold">M</div>
                <div>
                  <div class="font-semibold leading-5">Meera (41)</div>
                  <div class="text-[11px] text-gray-400">School teacher, Pune</div>
                </div>
              </div>
            </button>
          </div>

          <!-- Dynamic story (top-left only) -->
          <div class="mt-3">
            <div class="text-[11px] uppercase tracking-wide text-gray-400 mb-1">Patient story</div>
            <div id="story" class="text-sm leading-relaxed text-gray-200"></div>
          </div>
        </div>

        <!-- KPIs -->
        <div class="grid grid-cols-2 gap-2">
          <div class="kpi"><div class="label">eGFR</div><div id="egfrNow" class="value">—</div><div id="egfrStage" class="sub"> </div></div>
          <div class="kpi"><div class="label">KFRE 2-yr</div><div id="kfre2" class="value">—</div><div id="kfre2Cat" class="sub"> </div></div>
          <div class="kpi"><div class="label">KFRE 5-yr</div><div id="kfre5" class="value">—</div><div id="kfre5Cat" class="sub"> </div></div>
          <div class="kpi"><div class="label">10-yr CVD</div><div id="cvd10" class="value">—</div><div id="cvdCat" class="sub"> </div></div>
        </div>
      </section>

      <!-- Right pane -->
      <section class="lg:col-span-8 space-y-4 stack-tight">
        <div class="card">
          <h2 class="text-base sm:text-lg font-semibold mb-3">Clinical inputs</h2>
          <div class="grid gap-4">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
              <div>
                <div class="labelRow"><span>Age</span><span id="ageTxt">40 yrs</span></div>
                <input id="age" type="range" min="18" max="85" value="40" class="w-full">
              </div>
              <div>
                <div class="labelRow"><span>Height</span><span id="htTxt">170 cm</span></div>
                <input id="height" type="range" min="140" max="200" value="170" class="w-full">
              </div>
              <div>
                <div class="labelRow"><span>Weight</span><span id="wtTxt">74 kg</span></div>
                <input id="weight" type="range" min="40" max="130" value="74" class="w-full">
              </div>
              <div>
                <label class="labelRow"><span>Sex</span></label>
                <select id="sex" class="w-full rounded-lg bg-base-soft border border-base-border p-2">
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
              </div>
              <div>
                <label class="labelRow"><span>Population (BMI)</span></label>
                <select id="population" class="w-full rounded-lg bg-base-soft border border-base-border p-2">
                  <option value="asian">South/East Asian</option>
                  <option value="general">General</option>
                </select>
              </div>
              <div class="flex items-end">
                <div class="pill w-full justify-between"><span id="bmiTxt">BMI 25.6</span></div>
              </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
              <div>
                <div class="labelRow"><span>Creatinine</span><span id="crTxt">1.00 mg/dL</span></div>
                <input id="creatinine" type="range" min="0.5" max="6" step="0.01" value="1.0" class="w-full">
              </div>
              <div>
                <div class="labelRow"><span>UACR</span><span id="uacrTxt">250 mg/g</span></div>
                <input id="uacr" type="range" min="5" max="1200" step="1" value="250" class="w-full">
              </div>
              <div>
                <div class="labelRow"><span>SBP</span><span id="sbpTxt">140 mmHg</span></div>
                <input id="sbp" type="range" min="90" max="200" value="140" class="w-full">
              </div>
              <div>
                <div class="labelRow"><span>HbA1c</span><span id="a1cTxt">7.5 %</span></div>
                <input id="a1c" type="range" min="5" max="12" step="0.1" value="7.5" class="w-full">
              </div>
              <div>
                <div class="labelRow"><span>Total-C</span><span id="tcTxt">200 mg/dL</span></div>
                <input id="tc" type="range" min="120" max="320" value="200" class="w-full">
              </div>
              <div>
                <div class="labelRow"><span>HDL-C</span><span id="hdlTxt">45 mg/dL</span></div>
                <input id="hdl" type="range" min="20" max="100" value="45" class="w-full">
              </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2">
              <label class="pill"><input id="diabetes" type="checkbox" class="mr-2">Diabetes</label>
              <label class="pill"><input id="hypertension" type="checkbox" class="mr-2" checked>Hypertension</label>
              <label class="pill"><input id="smoker" type="checkbox" class="mr-2">Current smoker</label>
              <label class="pill"><input id="bpControl" type="checkbox" class="mr-2">BP controlled (&lt;130)</label>
              <label class="pill"><input id="acei" type="checkbox" class="mr-2" checked>On ACEi/ARB</label>
              <label class="pill"><input id="sglt2i" type="checkbox" class="mr-2">On SGLT2i</label>
              <label class="pill"><input id="mra" type="checkbox" class="mr-2">On MRA (if DM)</label>
              <label class="pill"><input id="statin" type="checkbox" class="mr-2">On statin</label>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 grid-tight">
          <div class="card">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold text-sm sm:text-base">Kidney function projection (eGFR — 5 yrs)</h3>
              <div class="text-[11px] text-gray-400">Current • Simulated • Optimal</div>
            </div>
            <canvas id="egfrChart" height="240" aria-label="eGFR chart"></canvas>
          </div>
          <div class="card">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold text-sm sm:text-base">CVD risk projection (10-yr PREVENT)</h3>
              <div class="text-[11px] text-gray-400">Current • Simulated • Optimal</div>
            </div>
            <canvas id="cvdChart" height="240" aria-label="CVD chart"></canvas>
          </div>
        </div>

        <p class="text-[11px] text-gray-400 px-1">Educational simulation. Not medical advice.</p>
      </section>
    </div>
  </main>

  <script>
    /* ---------- State ---------- */
    const s = { profile: 'arjun', theme: 'dark' };
    const $ = id => document.getElementById(id);

    /* ---------- DOM cache ---------- */
    const dom = {
      cardArjun: $('cardArjun'), cardMeera: $('cardMeera'), story: $('story'),
      age:$('age'), height:$('height'), weight:$('weight'),
      sex:$('sex'), population:$('population'),
      creatinine:$('creatinine'), uacr:$('uacr'), sbp:$('sbp'),
      a1c:$('a1c'), tc:$('tc'), hdl:$('hdl'),
      diabetes:$('diabetes'), hypertension:$('hypertension'),
      smoker:$('smoker'), bpControl:$('bpControl'),
      acei:$('acei'), sglt2i:$('sglt2i'), mra:$('mra'), statin:$('statin'),
      ageTxt:$('ageTxt'), htTxt:$('htTxt'), wtTxt:$('wtTxt'),
      crTxt:$('crTxt'), uacrTxt:$('uacrTxt'), sbpTxt:$('sbpTxt'),
      a1cTxt:$('a1cTxt'), tcTxt:$('tcTxt'), hdlTxt:$('hdlTxt'), bmiTxt:$('bmiTxt'),
      egfrNow:$('egfrNow'), egfrStage:$('egfrStage'),
      kfre2:$('kfre2'), kfre2Cat:$('kfre2Cat'), kfre5:$('kfre5'), kfre5Cat:$('kfre5Cat'),
      cvd10:$('cvd10'), cvdCat:$('cvdCat'),
      themeToggle:$('themeToggle'), themeState:$('themeState')
    };

    /* ---------- Helpers ---------- */
    const round = (v,d=1)=>{ const p=10**d; return Math.round(v*p)/p };
    const clamp = (n,a,b)=> Math.max(a, Math.min(b,n));
    function bmi(w, h){ const m=h/100; return w/(m*m) }
    function bmiCategory(b, pop){
      const asian = (pop==='asian');
      const th = { normal: asian?23:25, over: asian?27.5:30 };
      if (b<18.5) return 'Underweight';
      if (b<th.normal) return 'Normal';
      if (b<th.over) return 'Overweight';
      return 'Obese';
    }

    // CKD-EPI 2021 (race-free) — rounded for display but full value used in projections
    function egfrCKDEPI2021(age, sex, scr) {
      const k = sex === 'female' ? 0.7 : 0.9;
      const a = sex === 'female' ? -0.241 : -0.302;
      const sexFactor = sex === 'female' ? 1.012 : 1.0;
      const e = 142 * Math.pow(Math.min(scr/k,1), a) * Math.pow(Math.max(scr/k,1), -1.2) * Math.pow(0.9938, age) * sexFactor;
      return e;
    }
    function egfrStageText(e){
      const er = Math.round(e);
      if (er >= 90) return 'G1';
      if (er >= 60) return 'G2';
      if (er >= 45) return 'G3a';
      if (er >= 30) return 'G3b';
      if (er >= 15) return 'G4';
      return 'G5';
    }

    /* ---------- KFRE per your Excel ---------- 
       5y: 100*(1 - 0.937^EXP(LP))
       2y: 100*(1 - 0.983^EXP(LP))
       LP = -0.2218*(age/10 - 7.036)
          + 0.2553*(male - 0.5642)
          - 0.5541*(eGFR/5 - 7.222)
          + 0.4562*(LN(UACR) - 5.137)
          - 0.1475*(BPcontrolled - 0.5106)
          + 0.1426*(Diabetes - 0.8501)
    ------------------------------------------- */
    function kfreLP({age, male, egfr, uacr, bpControlled, diabetes}){
      return (-0.2218*(age/10 - 7.036))
           + ( 0.2553*(male - 0.5642))
           + (-0.5541*(egfr/5 - 7.222))
           + ( 0.4562*(Math.log(uacr) - 5.137))
           + (-0.1475*(bpControlled - 0.5106))
           + ( 0.1426*(diabetes - 0.8501));
    }
    function kfreRisk(years, lp){
      const base = years===5 ? 0.937 : 0.983;
      return clamp(100*(1 - Math.pow(base, Math.exp(lp))), 0, 100);
    }

    /* ---------- PREVENT total CVD 10-yr (published coefficients) ---------- */
    function prevent10(p){
      const age_term = (p.age - 55)/10;
      const nonHDL_mmol = (p.totalChol - p.hdl) * 0.02586;
      const hdl_mmol = p.hdl * 0.02586;
      const nonHDL_term = nonHDL_mmol - 3.5;
      const hdl_term = (hdl_mmol - 1.3)/0.3;
      const sbp_min = (Math.min(p.sbp,110)-110)/20;
      const sbp_max = (Math.max(p.sbp,110)-130)/20;
      const diabetes = p.diabetes?1:0;
      const smoker = p.smoker?1:0;
      const egfr_min = (Math.min(p.egfr,60)-60)/-15;
      const egfr_max = (Math.max(p.egfr,60)-90)/-15;
      const htnMeds = p.onACEi?1:0;
      const statin = p.statin?1:0;

      let L=0;
      if(p.sex==='female'){
        L = -3.307728 + 0.7939329*age_term + 0.0305239*nonHDL_term -0.1606857*hdl_term
          -0.2394003*sbp_min +0.360078*sbp_max +0.8667604*diabetes +0.5360739*smoker
          +0.6045917*egfr_min +0.0433769*egfr_max +0.3151672*htnMeds -0.1477655*statin
          -0.0663612*htnMeds*sbp_max +0.1197879*statin*nonHDL_term
          -0.0819715*age_term*nonHDL_term +0.0306769*age_term*hdl_term
          -0.0946348*age_term*sbp_max -0.27057*age_term*diabetes
          -0.078715*age_term*smoker -0.1637806*age_term*egfr_min;
      } else {
        L = -3.031168 + 0.7688528*age_term + 0.0736174*nonHDL_term -0.0954431*hdl_term
          -0.4347345*sbp_min +0.3362658*sbp_max +0.7692857*diabetes +0.4386871*smoker
          +0.5378979*egfr_min +0.0164827*egfr_max +0.288879*htnMeds -0.1337349*statin
          -0.0475924*htnMeds*sbp_max +0.150273*statin*nonHDL_term
          -0.0517874*age_term*nonHDL_term +0.0191169*age_term*hdl_term
          -0.1049477*age_term*sbp_max -0.2251948*age_term*diabetes
          -0.0895067*age_term*smoker -0.1543702*age_term*egfr_min;
      }
      return 100 * (Math.exp(L)/(1+Math.exp(L)));
    }

    /* ---------- eGFR 5-yr projection engine with treatment effects ---------- */
    function egfrProjection(startEgfr, cfg){
      const years = 5;
      let e = startEgfr;
      const series = [round(e,1)];
      for(let y=1; y<=years; y++){
        let slope = 0.7 + (cfg.age>60 ? 0.2 : 0);            // baseline age
        if(cfg.sbp > 130) slope += (cfg.sbp-130)/40;         // BP penalty
        if(cfg.diabetes && cfg.a1c > 7) slope += (cfg.a1c-7)*0.25;
        if(cfg.smoker) slope += 0.6;
        const bmiThr = cfg.population==='asian' ? 23 : 25;
        if(cfg.bmi >= bmiThr) slope += (cfg.bmi - bmiThr)*0.05;
        if(cfg.uacr >= 300) slope += 0.6;
        if(cfg.egfr < 45) slope += 0.4;

        // protections (each acts independently)
        if(cfg.bpControlled) slope -= 0.5;
        if(cfg.onACEi)       slope -= 0.6;
        if(cfg.onSGLT2i)     slope -= 1.0;
        if(cfg.onMRA && cfg.diabetes) slope -= 0.4;

        slope = clamp(slope, 0.1, 3.0);
        e = Math.max(0, e - slope);
        series.push(round(e,1));
      }
      return series;
    }

    /* ---------- CVD 10-yr path with changing eGFR ---------- */
    function cvdProjection(baseParams, egfrSeries){
      const out = [];
      for(let i=0;i<egfrSeries.length;i++){
        const p = {...baseParams, age: baseParams.age + i, egfr: egfrSeries[i]};
        out.push(round(prevent10(p),1));
      }
      return out;
    }

    /* ---------- Charts ---------- */
    const labels5 = Array.from({length:6},(_,i)=>`${i}y`);
    let egfrChart, cvdChart;

    function initCharts(){
      const eg = $('egfrChart'), cv = $('cvdChart');
      egfrChart = new Chart(eg, {
        type: 'line',
        data: { labels: labels5, datasets: [
          {label:'Current', data: [], borderWidth:3, tension:.25, pointRadius:0, borderColor:'rgb(239,68,68)', backgroundColor:'rgba(239,68,68,.1)'},
          {label:'Simulated', data: [], borderWidth:3, borderDash:[6,4], tension:.25, pointRadius:0, borderColor:'rgb(59,130,246)', backgroundColor:'rgba(59,130,246,.1)'},
          {label:'Optimal', data: [], borderWidth:3, tension:.25, pointRadius:0, borderColor:'rgb(34,197,94)', backgroundColor:'rgba(34,197,94,.1)'}
        ]},
        options: {
          responsive:true, maintainAspectRatio:false,
          scales:{ y:{ title:{display:true, text:'eGFR (mL/min/1.73m²)'}, min:0, max:110 } },
          plugins:{ legend:{display:false} }
        }
      });

      cvdChart = new Chart(cv, {
        type: 'line',
        data: { labels: labels5, datasets: [
          {label:'Current', data: [], borderWidth:3, tension:.25, pointRadius:0, borderColor:'rgb(239,68,68)', backgroundColor:'rgba(239,68,68,.1)'},
          {label:'Simulated', data: [], borderWidth:3, borderDash:[6,4], tension:.25, pointRadius:0, borderColor:'rgb(59,130,246)', backgroundColor:'rgba(59,130,246,.1)'},
          {label:'Optimal', data: [], borderWidth:3, tension:.25, pointRadius:0, borderColor:'rgb(34,197,94)', backgroundColor:'rgba(34,197,94,.1)'}
        ]},
        options: {
          responsive:true, maintainAspectRatio:false,
          scales:{ y:{ title:{display:true, text:'10-yr CVD risk (%)'}, min:0, max:100 } },
          plugins:{ legend:{display:false} }
        }
      });
    }

    function kpiBand(v,type){
      if(type==='cvd'){ if(v<5) return 'Low'; if(v<10) return 'Borderline'; if(v<20) return 'Intermediate'; return 'High' }
      // KFRE
      if(v<2) return 'Low';
      if(v<5) return 'Intermediate';
      if(v<15) return 'High';
      return 'Very High';
    }

    function updateStory(profile, vals){
      const {age, sex, bmi, population, sbp, a1c, uacr} = vals;
      const city = 'Pune';
      const bmiCat = bmiCategory(bmi, population).toLowerCase();
      const smokeTxt = vals.smoker ? 'currently smokes' : 'is a non-smoker';
      const bpTxt = vals.bpControlled ? 'controlled' : 'uncontrolled';
      const dmTxt = vals.diabetes ? `with HbA1c ${a1c}%` : 'without diabetes';
      const acrTxt = uacr>=300 ? 'severely increased UACR' : (uacr>=30 ? 'moderately increased UACR' : 'normal UACR');
      const gfrTxt = `${Math.round(vals.egfr)} (${egfrStageText(vals.egfr)})`;

      const intro = profile==='arjun'
        ? `Arjun is a ${age}-year-old man from ${city} with ${bmiCat} BMI (${round(bmi,1)}). He ${smokeTxt} and has ${bpTxt} blood pressure (SBP ${sbp}).`
        : `Meera is a ${age}-year-old woman from ${city} with ${bmiCat} BMI (${round(bmi,1)}). She ${smokeTxt} and has ${bpTxt} blood pressure (SBP ${sbp}).`;

      const meds = [
        vals.acei ? 'on ACEi/ARB' : null,
        vals.sglt2i ? 'on SGLT2i' : null,
        (vals.mra && vals.diabetes) ? 'on MRA' : null,
        vals.statin ? 'on a statin' : null
      ].filter(Boolean).join(', ');

      const tail = ` Kidney function by CKD-EPI is eGFR ${gfrTxt}; albuminuria is ${acrTxt}. ${vals.diabetes ? `Diabetes present ${dmTxt}. ` : 'No diabetes. '}${meds ? meds+'.' : ''}`;

      dom.story.textContent = intro + tail;
    }

    /* ---------- Compute + render ---------- */
    function compute(){
      const age = +dom.age.value, height=+dom.height.value, weight=+dom.weight.value;
      const sex = dom.sex.value, population=dom.population.value;
      const creatinine=+dom.creatinine.value, uacr=Math.max(5,+dom.uacr.value);
      const sbp=+dom.sbp.value, a1c=+dom.a1c.value, totalChol=+dom.tc.value, hdl=+dom.hdl.value;
      const diabetes=dom.diabetes.checked, smoker=dom.smoker.checked, bpControlled=dom.bpControl.checked;
      const onACEi=dom.acei.checked, onSGLT2i=dom.sglt2i.checked, onMRA=dom.mra.checked, statin=dom.statin.checked;

      // label updates
      const B = bmi(weight, height);
      dom.ageTxt.textContent = `${age} yrs`;
      dom.htTxt.textContent = `${height} cm`;
      dom.wtTxt.textContent = `${weight} kg`;
      dom.crTxt.textContent = `${creatinine.toFixed(2)} mg/dL`;
      dom.uacrTxt.textContent = `${uacr} mg/g`;
      dom.sbpTxt.textContent = `${sbp} mmHg`;
      dom.a1cTxt.textContent = `${a1c.toFixed(1)} %`;
      dom.tcTxt.textContent = `${totalChol} mg/dL`;
      dom.hdlTxt.textContent = `${hdl} mg/dL`;
      dom.bmiTxt.textContent = `BMI ${round(B,1)} • ${bmiCategory(B, population)}`;

      // eGFR current
      const egfrExact = egfrCKDEPI2021(age, sex, creatinine);
      dom.egfrNow.textContent = Math.round(egfrExact);
      dom.egfrStage.textContent = egfrStageText(egfrExact);

      // Story (top-left only)
      updateStory(s.profile, {
        age, sex, bmi:B, population, sbp, a1c, uacr,
        smoker, bpControlled, diabetes,
        acei:onACEi, sglt2i:onSGLT2i, mra:onMRA, statin, egfr: egfrExact
      });

      // KFRE (exact Excel spec)
      const lp = kfreLP({age, male:(sex==='male'?1:0), egfr:egfrExact, uacr, bpControlled, diabetes:(diabetes?1:0)});
      const r2 = round(kfreRisk(2, lp),1), r5 = round(kfreRisk(5, lp),1);
      dom.kfre2.textContent = `${r2}%`; dom.kfre2Cat.textContent = kpiBand(r2,'kfre');
      dom.kfre5.textContent = `${r5}%`; dom.kfre5Cat.textContent = kpiBand(r5,'kfre');

      // Baseline params for CVD
      const baseCVD = { age, sex, sbp, totalChol, hdl, diabetes, smoker, egfr: egfrExact, onACEi, statin };

      // Current path (no added controls)
      const egCurrent = egfrProjection(egfrExact, {
        age, sbp, diabetes, a1c, smoker, bmi:B, population, uacr, egfr:egfrExact,
        bpControlled:false, onACEi, onSGLT2i:false, onMRA:false
      });
      const cvCurrent = cvdProjection(baseCVD, egCurrent);

      // Simulated: use toggles as interventions
      const simSBP = bpControlled ? Math.min(sbp, 125) : sbp;
      const simA1c = diabetes ? Math.min(a1c, 7.0) : a1c;
      const egSim = egfrProjection(egfrExact, {
        age, sbp:simSBP, diabetes, a1c:simA1c, smoker, bmi:B, population, uacr, egfr:egfrExact,
        bpControlled, onACEi, onSGLT2i, onMRA
      });
      const cvSim = cvdProjection({ ...baseCVD, sbp:simSBP }, egSim);

      // Optimal: non-smoker, SBP ~123, A1c 6.8 if DM, BMI to threshold, ACEi+SGLT2i+MRA(if DM)+statin
      const egOpt = egfrProjection(egfrExact, {
        age, sbp:123, diabetes, a1c: diabetes?6.8:a1c, smoker:false,
        bmi: Math.min(B, population==='asian'?23:25), population, uacr, egfr:egfrExact,
        bpControlled:true, onACEi:true, onSGLT2i:true, onMRA:diabetes
      });
      const cvOpt = cvdProjection({ ...baseCVD, sbp:123, smoker:false, onACEi:true, statin:true }, egOpt);

      // Charts
      egfrChart.data.datasets[0].data = egCurrent;
      egfrChart.data.datasets[1].data = egSim;
      egfrChart.data.datasets[2].data = egOpt;
      egfrChart.update();

      cvdChart.data.datasets[0].data = cvCurrent;
      cvdChart.data.datasets[1].data = cvSim;
      cvdChart.data.datasets[2].data = cvOpt;
      cvdChart.update();

      // headline CVD (year 0)
      dom.cvd10.textContent = `${round(prevent10(baseCVD),1)}%`;
      dom.cvdCat.textContent = kpiBand(round(prevent10(baseCVD),1),'cvd');
    }

    /* ---------- Profile presets and theme ---------- */
    function applyProfile(p){
      s.profile = p;
      dom.cardArjun.classList.toggle('btn-tab-active', p==='arjun');
      dom.cardMeera.classList.toggle('btn-tab-active', p==='meera');

      if(p==='arjun'){
        dom.sex.value = 'male';
        dom.age.value = 35; dom.height.value = 173; dom.weight.value = 76;
        dom.creatinine.value = 1.05; dom.uacr.value = 50;
        dom.sbp.value = 132; dom.a1c.value = 5.8; dom.tc.value = 190; dom.hdl.value = 48;
        dom.diabetes.checked = false; dom.hypertension.checked = true;
        dom.smoker.checked = false; dom.bpControl.checked = true;
        dom.acei.checked = true; dom.sglt2i.checked = false; dom.mra.checked = false; dom.statin.checked=false;
      } else {
        dom.sex.value = 'female';
        dom.age.value = 41; dom.height.value = 162; dom.weight.value = 84;
        dom.creatinine.value = 1.0; dom.uacr.value = 250;
        dom.sbp.value = 146; dom.a1c.value = 7.8; dom.tc.value = 210; dom.hdl.value = 40;
        dom.diabetes.checked = true; dom.hypertension.checked = true;
        dom.smoker.checked = false; dom.bpControl.checked = false;
        dom.acei.checked = true; dom.sglt2i.checked = true; dom.mra.checked = true; dom.statin.checked=true;
      }
      compute();
    }

    function setTheme(mode){
      const root = document.documentElement;
      if(mode==='dark'){ root.classList.add('dark'); root.classList.remove('light'); dom.themeState.textContent='Dark'; }
      else { root.classList.remove('dark'); root.classList.add('light'); dom.themeState.textContent='Light'; }
      s.theme = mode;
      egfrChart?.update('none'); cvdChart?.update('none');
    }

    /* ---------- Wire up ---------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      initCharts();

      // Profile switching (fixes Meera not updating)
      dom.cardArjun.addEventListener('click', ()=> applyProfile('arjun'));
      dom.cardMeera.addEventListener('click', ()=> applyProfile('meera'));

      // Inputs: update on both input & change for smooth sliders + toggles
      document.querySelectorAll('input,select').forEach(el=>{
        el.addEventListener('input', compute);
        el.addEventListener('change', compute);
      });

      dom.themeToggle.addEventListener('click', ()=> setTheme(s.theme==='dark' ? 'light' : 'dark'));

      // Defaults
      applyProfile('arjun');
      setTheme('dark');
    });
  </script>
</body>
</html>
