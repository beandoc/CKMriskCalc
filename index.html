<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cardiorenal Journey — Patient Stories</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Compact controls */
    .slider::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:16px;height:16px;border-radius:9999px;background:#60a5fa;box-shadow:0 0 0 2px #1f2937 inset; }
    .slider::-moz-range-thumb{ width:16px;height:16px;border-radius:9999px;background:#60a5fa;border:0; }
    .card { @apply rounded-2xl shadow-lg border border-gray-700/20 dark:border-white/10 bg-white dark:bg-gray-900; }
    .metric { @apply rounded-xl px-4 py-3 text-center bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700; }
    .pill { @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium border; }
    .btn { @apply inline-flex items-center rounded-lg px-3 py-2 text-sm font-medium bg-gray-900 text-white dark:bg-white dark:text-gray-900 hover:opacity-90; }
    .toggle input { display:none; }
    .toggle span { @apply w-10 h-6 rounded-full bg-gray-300 dark:bg-gray-700 inline-flex items-center p-0.5 transition; }
    .toggle span i { @apply w-5 h-5 rounded-full bg-white dark:bg-gray-900 translate-x-0 transition; }
    .toggle input:checked + span i { transform: translateX(1rem); }
  </style>
</head>
<body class="h-full bg-gray-100 text-gray-900 dark:bg-gray-950 dark:text-gray-100">
  <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-4">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-xl sm:text-2xl font-semibold">Cardiorenal Journey — Patient Stories</h1>
        <p class="text-sm text-gray-600 dark:text-gray-400">Select a hypothetical patient, review risks, and simulate treatment impact.</p>
      </div>
      <label class="toggle cursor-pointer flex items-center gap-2">
        <span class="text-sm">Theme</span>
        <input id="themeToggle" type="checkbox" checked>
        <span><i></i></span>
      </label>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- LEFT: Patient selection -->
      <section class="card p-4 lg:col-span-1">
        <h2 class="text-base font-semibold mb-3">Select a hypothetical patient</h2>

        <div class="grid grid-cols-2 gap-3">
          <!-- Arjun card -->
          <button id="cardArjun" class="group relative flex flex-col items-start rounded-2xl border border-blue-500/40 bg-blue-50/50 dark:bg-blue-900/10 p-3 focus:outline-none focus:ring-2 ring-blue-400 aria-selected:true">
            <div class="flex items-center gap-2 w-full">
              <div class="h-7 w-7 rounded-full bg-blue-600 text-white grid place-content-center font-semibold">A</div>
              <div class="text-left">
                <div class="text-sm font-semibold">Arjun (<span id="arjunAgeLbl">35</span>)</div>
                <div class="text-[11px] text-gray-600 dark:text-gray-400">IT engineer, Pune</div>
              </div>
            </div>
            <div id="arjunDesc" class="mt-2 text-[13px] text-left">
              Arjun is a 35-year-old non-smoker from Pune with early hypertension controlled on ACEi. He’s focused on preventing kidney and heart problems after his father’s bypass at 58.
            </div>
          </button>

          <!-- Meera card -->
          <button id="cardMeera" class="group relative flex flex-col items-start rounded-2xl border border-gray-300 dark:border-white/10 p-3 focus:outline-none focus:ring-2 ring-blue-400">
            <div class="flex items-center gap-2 w-full">
              <div class="h-7 w-7 rounded-full bg-pink-600 text-white grid place-content-center font-semibold">M</div>
              <div class="text-left">
                <div class="text-sm font-semibold">Meera (<span id="meeraAgeLbl">41</span>)</div>
                <div class="text-[11px] text-gray-600 dark:text-gray-400">School teacher, Pune</div>
              </div>
            </div>
            <div id="meeraDesc" class="mt-2 text-[13px] line-clamp-3 opacity-70">
              Meera is a 41-year-old with type 2 diabetes and dyslipidaemia. BP has been high and UACR is elevated; she’s motivated to improve diet and start SGLT2i if beneficial.
            </div>
          </button>
        </div>
      </section>

      <!-- MIDDLE+RIGHT: Inputs & results -->
      <section class="card p-4 lg:col-span-2">
        <h2 class="text-base font-semibold mb-3">Clinical inputs</h2>
        <!-- Inputs: compact responsive grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4">
          <!-- Age -->
          <div>
            <label class="text-xs text-gray-600 dark:text-gray-400">Age: <span id="ageLbl" class="font-semibold">41</span> yrs</label>
            <input id="age" type="range" min="18" max="85" value="41" class="w-full slider" />
          </div>
          <!-- Sex -->
          <div>
            <label class="text-xs text-gray-600 dark:text-gray-400">Sex</label>
            <select id="sex" class="mt-1 w-full rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 p-2 text-sm">
              <option value="female" selected>Female</option>
              <option value="male">Male</option>
            </select>
          </div>
          <!-- Height -->
          <div>
            <label class="text-xs text-gray-600 dark:text-gray-400">Height: <span id="heightLbl" class="font-semibold">162</span> cm</label>
            <input id="height" type="range" min="140" max="200" value="162" class="w-full slider" />
          </div>
          <!-- Weight -->
          <div>
            <label class="text-xs text-gray-600 dark:text-gray-400">Weight: <span id="weightLbl" class="font-semibold">84</span> kg</label>
            <input id="weight" type="range" min="40" max="150" value="84" class="w-full slider" />
          </div>
          <!-- Creatinine -->
          <div>
            <label class="text-xs text-gray-600 dark:text-gray-400">Serum creatinine: <span id="crLbl" class="font-semibold">1.00</span> mg/dL</label>
            <input id="scr" type="range" min="0.5" max="5" step="0.01" value="1.00" class="w-full slider" />
          </div>
          <!-- UACR -->
          <div>
            <label class="text-xs text-gray-600 dark:text-gray-400">UACR: <span id="uacrLbl" class="font-semibold">250</span> mg/g</label>
            <input id="uacr" type="range" min="5" max="3000" step="5" value="250" class="w-full slider" />
          </div>
          <!-- SBP -->
          <div>
            <label class="text-xs text-gray-600 dark:text-gray-400">Systolic BP: <span id="sbpLbl" class="font-semibold">146</span> mmHg</label>
            <input id="sbp" type="range" min="90" max="200" value="146" class="w-full slider" />
          </div>
          <!-- Lipids -->
          <div>
            <label class="text-xs text-gray-600 dark:text-gray-400">Total cholesterol: <span id="tcLbl" class="font-semibold">220</span> mg/dL</label>
            <input id="tc" type="range" min="120" max="300" value="220" class="w-full slider" />
          </div>
          <div>
            <label class="text-xs text-gray-600 dark:text-gray-400">HDL: <span id="hdlLbl" class="font-semibold">40</span> mg/dL</label>
            <input id="hdl" type="range" min="20" max="100" value="40" class="w-full slider" />
          </div>
        </div>

        <!-- Toggles row -->
        <div class="mt-3 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 text-sm">
          <label class="inline-flex items-center gap-2"><input id="diabetes" type="checkbox"><span>Diabetes</span></label>
          <label class="inline-flex items-center gap-2"><input id="htn" type="checkbox" checked><span>Hypertension</span></label>
          <label class="inline-flex items-center gap-2"><input id="smoker" type="checkbox"><span>Current smoker</span></label>
          <label class="inline-flex items-center gap-2"><input id="bpCtrl" type="checkbox"><span>BP controlled (&lt;130)</span></label>
          <label class="inline-flex items-center gap-2"><input id="acei" type="checkbox" checked><span>On ACEi/ARB</span></label>
          <label class="inline-flex items-center gap-2"><input id="statin" type="checkbox"><span>On statin</span></label>
          <label class="inline-flex items-center gap-2"><input id="sglt2i" type="checkbox"><span>On SGLT2i</span></label>
          <label class="inline-flex items-center gap-2"><input id="mra" type="checkbox"><span>On MRA (if DM)</span></label>
        </div>

        <!-- Summary tiles -->
        <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
          <div class="metric">
            <div class="text-[11px] opacity-70">eGFR</div>
            <div id="egfrOut" class="text-2xl font-semibold">80</div>
            <div id="gstage" class="text-[11px] opacity-70">G2</div>
          </div>
          <div class="metric">
            <div class="text-[11px] opacity-70">KFRE 2-yr</div>
            <div id="kfre2" class="text-2xl font-semibold">0.0%</div>
            <div id="kfre2c" class="text-[11px] opacity-70">Low</div>
          </div>
          <div class="metric">
            <div class="text-[11px] opacity-70">KFRE 5-yr</div>
            <div id="kfre5" class="text-2xl font-semibold">0.0%</div>
            <div id="kfre5c" class="text-[11px] opacity-70">Low</div>
          </div>
          <div class="metric">
            <div class="text-[11px] opacity-70">10-yr CVD</div>
            <div id="cvd10" class="text-2xl font-semibold">0.0%</div>
            <div id="cvd10c" class="text-[11px] opacity-70">—</div>
          </div>
          <div class="metric">
            <div class="text-[11px] opacity-70">5-yr CKM stage</div>
            <div id="ckm" class="text-2xl font-semibold">—</div>
            <div id="ckmTxt" class="text-[11px] opacity-70">—</div>
          </div>
          <div class="metric">
            <div class="text-[11px] opacity-70">BMI</div>
            <div id="bmiOut" class="text-2xl font-semibold">—</div>
            <div id="bmiTxt" class="text-[11px] opacity-70">—</div>
          </div>
        </div>

        <!-- Charts -->
        <div class="mt-5 grid grid-cols-1 xl:grid-cols-2 gap-4">
          <div class="card p-3">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-semibold">Kidney function projection (eGFR) — 5 years</h3>
              <span class="pill border-blue-500/40 text-blue-700 dark:text-blue-300">Current vs Simulated</span>
            </div>
            <canvas id="egfrChart" height="220"></canvas>
          </div>
          <div class="card p-3">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-semibold">CVD risk projection (10-yr PREVENT)</h3>
              <span class="pill border-emerald-500/40 text-emerald-700 dark:text-emerald-300">Current vs Simulated</span>
            </div>
            <canvas id="cvdChart" height="220"></canvas>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // --- THEME ---
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme() {
      if (themeToggle.checked) document.documentElement.classList.add('dark');
      else document.documentElement.classList.remove('dark');
      // Force chart recolor on theme switch
      setTimeout(updateAll, 50);
    }
    themeToggle.addEventListener('change', applyTheme);
    applyTheme();

    // --- ELEMENTS ---
    const el = id => document.getElementById(id);
    const inputs = {
      age: el('age'), sex: el('sex'),
      height: el('height'), weight: el('weight'),
      scr: el('scr'), uacr: el('uacr'), sbp: el('sbp'),
      tc: el('tc'), hdl: el('hdl'),
      diabetes: el('diabetes'), htn: el('htn'), smoker: el('smoker'),
      bpCtrl: el('bpCtrl'), acei: el('acei'), statin: el('statin'), sglt2i: el('sglt2i'), mra: el('mra')
    };
    const labels = {
      ageLbl: el('ageLbl'), heightLbl: el('heightLbl'), weightLbl: el('weightLbl'),
      crLbl: el('crLbl'), uacrLbl: el('uacrLbl'), sbpLbl: el('sbpLbl'), tcLbl: el('tcLbl'), hdlLbl: el('hdlLbl'),
      arjunAgeLbl: el('arjunAgeLbl'), meeraAgeLbl: el('meeraAgeLbl')
    };
    const outs = {
      egfr: el('egfrOut'), gstage: el('gstage'),
      kfre2: el('kfre2'), kfre2c: el('kfre2c'),
      kfre5: el('kfre5'), kfre5c: el('kfre5c'),
      cvd10: el('cvd10'), cvd10c: el('cvd10c'),
      ckm: el('ckm'), ckmTxt: el('ckmTxt'),
      bmi: el('bmiOut'), bmiTxt: el('bmiTxt')
    };

    // --- PROFILE CARDS ---
    const cardArjun = el('cardArjun');
    const cardMeera = el('cardMeera');
    const arjunDesc = el('arjunDesc');
    const meeraDesc = el('meeraDesc');
    let activeProfile = 'meera'; // default to Meera (matches labels)

    function selectProfile(name) {
      activeProfile = name;
      if (name === 'arjun') {
        cardArjun.classList.add('border-blue-500','bg-blue-50/50','dark:bg-blue-900/10');
        cardArjun.setAttribute('aria-selected', 'true');
        cardMeera.classList.remove('border-blue-500','bg-blue-50/50','dark:bg-blue-900/10');
        cardMeera.setAttribute('aria-selected', 'false');
        meeraDesc.classList.add('line-clamp-3','opacity-70');
        arjunDesc.classList.remove('line-clamp-3','opacity-70');
        // Prefill Arjun-ish values
        inputs.sex.value = 'male';
        inputs.age.value = 35;
        inputs.height.value = 173;
        inputs.weight.value = 78;
        inputs.scr.value = 1.1;
        inputs.uacr.value = 30;
        inputs.sbp.value = 132;
        inputs.tc.value = 210;
        inputs.hdl.value = 42;
        inputs.diabetes.checked = false;
        inputs.htn.checked = true;
        inputs.smoker.checked = false;
        inputs.bpCtrl.checked = false;
        inputs.acei.checked = true;
        inputs.statin.checked = false;
        inputs.sglt2i.checked = false;
        inputs.mra.checked = false;
      } else {
        cardMeera.classList.add('border-blue-500','bg-blue-50/50','dark:bg-blue-900/10');
        cardMeera.setAttribute('aria-selected', 'true');
        cardArjun.classList.remove('border-blue-500','bg-blue-50/50','dark:bg-blue-900/10');
        cardArjun.setAttribute('aria-selected', 'false');
        arjunDesc.classList.add('line-clamp-3','opacity-70');
        meeraDesc.classList.remove('line-clamp-3','opacity-70');
        // Prefill Meera-ish values
        inputs.sex.value = 'female';
        inputs.age.value = 41;
        inputs.height.value = 162;
        inputs.weight.value = 84;
        inputs.scr.value = 1.0;
        inputs.uacr.value = 250;
        inputs.sbp.value = 146;
        inputs.tc.value = 220;
        inputs.hdl.value = 40;
        inputs.diabetes.checked = true;
        inputs.htn.checked = true;
        inputs.smoker.checked = false;
        inputs.bpCtrl.checked = false;
        inputs.acei.checked = true;
        inputs.statin.checked = false;
        inputs.sglt2i.checked = false;
        inputs.mra.checked = false;
      }
      updateAll();
    }
    cardArjun.addEventListener('click', () => selectProfile('arjun'));
    cardMeera.addEventListener('click', () => selectProfile('meera'));

    // --- CORE FORMULAE ---

    // CKD-EPI 2021 (no race) — returns mL/min/1.73m²
    function egfrCKDEPI(age, sex, scr) {
      const k = sex === 'female' ? 0.7 : 0.9;
      const a = sex === 'female' ? -0.241 : -0.302;
      const sexFactor = sex === 'female' ? 1.012 : 1.0;
      const scrK = scr / k;
      const egfr = 142 * Math.pow(Math.min(scrK,1), a) * Math.pow(Math.max(scrK,1), -1.200) * Math.pow(0.9938, age) * sexFactor;
      return Math.max(0, Math.round(egfr));
    }
    function gfrStage(g) {
      if (g >= 90) return 'G1';
      if (g >= 60) return 'G2';
      if (g >= 45) return 'G3a';
      if (g >= 30) return 'G3b';
      if (g >= 15) return 'G4';
      return 'G5';
    }

    // KFRE (matches your spreadsheet exactly)
    function kfreRisk(years, age, sex, egfr, uacr, bpCtrlFlag, aceiFlag) {
      // map years -> baseline survival
      const S = years === 2 ? 0.983 : 0.937;
      const sexM = (sex === 'male') ? 1 : 0;
      // Centered linear predictor per your formula
      const LP =
        (-0.2218 * (age/10 - 7.036)) +
        (0.2553  * (sexM - 0.5642)) +
        (-0.5541 * (egfr/5 - 7.222)) +
        (0.4562  * (Math.log(uacr) - 5.137)) +
        (-0.1475 * (bpCtrlFlag - 0.5106)) +
        (0.1426  * (aceiFlag - 0.8501));
      const risk = 100 * (1 - Math.pow(S, Math.exp(LP)));
      return Math.max(0, Math.min(100, Math.round(risk*10)/10));
    }
    function riskBand(v, cut) {
      if (v < cut[0]) return 'Low';
      if (v < cut[1]) return 'Intermediate';
      if (v < cut[2]) return 'High';
      return 'Very high';
    }

    // PREVENT total CVD (10-yr) — coefficients from earlier version
    function prevent10(params) {
      const age_term = (params.age - 55) / 10;
      const nonHDL_mmol = (params.tc - params.hdl) * 0.02586;
      const hdl_mmol = params.hdl * 0.02586;
      const nonHDL_term = nonHDL_mmol - 3.5;
      const hdl_term = (hdl_mmol - 1.3) / 0.3;
      const sbp_min = (Math.min(params.sbp, 110) - 110) / 20;
      const sbp_max = (Math.max(params.sbp, 110) - 130) / 20;
      const diabetes_term = params.diabetes ? 1 : 0;
      const smoker_term = params.smoker ? 1 : 0;
      const egfr_min = (Math.min(params.egfr, 60) - 60) / -15;
      const egfr_max = (Math.max(params.egfr, 60) - 90) / -15;
      const htn_meds_term = params.acei ? 1 : 0;
      const statin_term = params.statin ? 1 : 0;

      let L=0;
      if (params.sex==='female') {
        L = -3.307728 + 0.7939329*age_term + 0.0305239*nonHDL_term -0.1606857*hdl_term -0.2394003*sbp_min +0.360078*sbp_max
          +0.8667604*diabetes_term +0.5360739*smoker_term +0.6045917*egfr_min +0.0433769*egfr_max
          +0.3151672*htn_meds_term -0.1477655*statin_term
          -0.0663612*htn_meds_term*sbp_max +0.1197879*statin_term*nonHDL_term
          -0.0819715*age_term*nonHDL_term +0.0306769*age_term*hdl_term -0.0946348*age_term*sbp_max
          -0.27057*age_term*diabetes_term -0.078715*age_term*smoker_term -0.1637806*age_term*egfr_min;
      } else {
        L = -3.031168 + 0.7688528*age_term +0.0736174*nonHDL_term -0.0954431*hdl_term -0.4347345*sbp_min +0.3362658*sbp_max
          +0.7692857*diabetes_term +0.4386871*smoker_term +0.5378979*egfr_min +0.0164827*egfr_max
          +0.288879*htn_meds_term -0.1337349*statin_term
          -0.0475924*htn_meds_term*sbp_max +0.150273*statin_term*nonHDL_term
          -0.0517874*age_term*nonHDL_term +0.0191169*age_term*hdl_term -0.1049477*age_term*sbp_max
          -0.2251948*age_term*diabetes_term -0.0895067*age_term*smoker_term -0.1543702*age_term*egfr_min;
      }
      const p = Math.exp(L)/(1+Math.exp(L));
      return Math.round(p*1000)/10; // %
    }

    // eGFR 5-year projection with treatment impact
    function egfrPath(start, p) {
      // base decline (mL/min/yr)
      let decline = 1.0; // age-related
      // penalties
      if (p.sbp > 130) decline += (p.sbp-130)/20 * 0.6;
      if (p.diabetes) decline += 0.6;
      if (p.uacr >= 30) decline += Math.min(1.2, Math.log(p.uacr/30+1));
      if (p.smoker) decline += 0.5;
      // protections
      if (p.acei) decline -= 0.4;
      if (p.sglt2i) decline -= 0.9;
      if (p.mra && p.diabetes) decline -= 0.3;
      decline = Math.max(0.2, decline);

      const arr=[start];
      let g = start;
      for (let y=1; y<=5; y++){
        g = Math.max(0, g - decline);
        arr.push(Math.round(g*10)/10);
      }
      return arr;
    }

    // --- CHARTS ---
    const egfrChart = new Chart(el('egfrChart'), {
      type:'line',
      data:{ labels:['Now','1y','2y','3y','4y','5y'],
        datasets:[
          {label:'Current', data:[0,0,0,0,0,0], borderWidth:3, tension:0.15, borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.1)'},
          {label:'Simulated', data:[0,0,0,0,0,0], borderWidth:3, borderDash:[6,4], tension:0.15, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,0.1)'}
        ]},
      options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ title:{display:true,text:'eGFR (mL/min/1.73m²)'} } }, plugins:{ legend:{display:false} } }
    });

    const cvdChart = new Chart(el('cvdChart'), {
      type:'line',
      data:{ labels:Array.from({length:11},(_,i)=> i===0?'Now':`${i}y`),
        datasets:[
          {label:'Current', data:new Array(11).fill(0), borderWidth:3, tension:0.15, borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.1)'},
          {label:'Simulated', data:new Array(11).fill(0), borderWidth:3, borderDash:[6,4], tension:0.15, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.1)'}
        ]},
      options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ title:{display:true,text:'10-yr CVD risk (%)'}, min:0, max:100 } }, plugins:{ legend:{display:false} } }
    });

    // --- UPDATE LOOP ---
    function computeState() {
      const age = +inputs.age.value;
      const sex = inputs.sex.value;
      const height = +inputs.height.value;
      const weight = +inputs.weight.value;
      const scr = +inputs.scr.value;
      const uacr = Math.max(5, +inputs.uacr.value);
      const sbp = +inputs.sbp.value;
      const tc = +inputs.tc.value;
      const hdl = +inputs.hdl.value;

      // labels
      labels.ageLbl.textContent = age;
      labels.heightLbl.textContent = height;
      labels.weightLbl.textContent = weight;
      el('crLbl').textContent = scr.toFixed(2);
      labels.uacrLbl.textContent = uacr;
      el('sbpLbl').textContent = sbp;
      el('tcLbl').textContent = tc;
      el('hdlLbl').textContent = hdl;
      labels.arjunAgeLbl.textContent = inputs.sex.value==='male' ? age : labels.arjunAgeLbl.textContent;
      labels.meeraAgeLbl.textContent = inputs.sex.value==='female' ? age : labels.meeraAgeLbl.textContent;

      const bmi = Math.round((weight/((height/100)**2))*10)/10;
      outs.bmi.textContent = bmi;
      outs.bmiTxt.textContent = bmi<23 ? 'Healthy' : (bmi<27.5 ? 'Overweight' : 'Obese');

      const egfr = egfrCKDEPI(age, sex, scr);
      outs.egfr.textContent = egfr;
      outs.gstage.textContent = gfrStage(egfr);

      // KFRE (uses your exact LP + baseline survivals)
      const k2 = kfreRisk(2, age, sex, egfr, uacr, inputs.bpCtrl.checked?1:0, inputs.acei.checked?1:0);
      const k5 = kfreRisk(5, age, sex, egfr, uacr, inputs.bpCtrl.checked?1:0, inputs.acei.checked?1:0);
      outs.kfre2.textContent = `${k2.toFixed(1)}%`;
      outs.kfre5.textContent = `${k5.toFixed(1)}%`;
      outs.kfre2c.textContent = riskBand(k2,[2,10,20]);
      outs.kfre5c.textContent = riskBand(k5,[5,15,30]);

      // PREVENT now
      const base = { age, sex, tc, hdl, sbp, diabetes:inputs.diabetes.checked, smoker:inputs.smoker.checked, egfr, acei:inputs.acei.checked, statin:inputs.statin.checked };
      const cvdNow = prevent10(base);
      outs.cvd10.textContent = `${cvdNow.toFixed(1)}%`;
      outs.cvd10c.textContent = riskBand(cvdNow,[5,10,20]);

      // CKM (simple)
      const ckmStage = (egfr<30 || cvdNow>=20) ? ['4','High CV/renal'] : (egfr<45 || uacr>=300) ? ['3b','Adv. kidney/CV risk'] :
                       (egfr<60 || uacr>=30) ? ['3a','Mod. kidney/CV risk'] : ['2','Metabolic risk'];
      outs.ckm.textContent = ckmStage[0];
      outs.ckmTxt.textContent = ckmStage[1];

      // Simulated scenario: control BP <130, A1c proxy by diabetes unchanged, add statin+SGLT2i, keep ACEi
      const sim = { ...base,
        sbp: Math.min(sbp, 128),
        statin: true,
        acei: true,
        smoker: false,
      };
      // eGFR paths (5y)
      const egfrCurrent = egfrPath(egfr, { sbp, diabetes:inputs.diabetes.checked, uacr, smoker:inputs.smoker.checked, acei:inputs.acei.checked, sglt2i:inputs.sglt2i.checked, mra:inputs.mra.checked });
      const egfrSim = egfrPath(egfr, { sbp:sim.sbp, diabetes:inputs.diabetes.checked, uacr:Math.max(10, uacr*0.8), smoker:false, acei:true, sglt2i:true, mra:inputs.mra.checked });

      egfrChart.data.datasets[0].data = egfrCurrent;
      egfrChart.data.datasets[1].data = egfrSim;
      egfrChart.update('none');

      // 10 points yearly CVD using PREVENT + evolving age & egfr (from the two paths)
      const cvNow = [];
      const cvSim = [];
      for (let y=0; y<=10; y++){
        const eg_y_now = (y<=5? egfrCurrent[y] : egfrCurrent[5]);
        const eg_y_sim = (y<=5? egfrSim[y] : egfrSim[5]);
        cvNow.push( prevent10({ ...base, age: age+y, egfr: eg_y_now }) );
        cvSim.push( prevent10({ ...sim , age: age+y, egfr: eg_y_sim }) );
      }
      cvdChart.data.datasets[0].data = cvNow;
      cvdChart.data.datasets[1].data = cvSim;
      cvdChart.update('none');

      // Dynamic profile text (only selected card expands & updates)
      const summary = (who) => {
        const smokeTxt = inputs.smoker.checked ? 'smokes currently' : 'does not smoke';
        const bpTxt = inputs.bpCtrl.checked || inputs.sbp.value<130 ? 'BP is controlled' : `BP around ${sbp} mmHg`;
        const dmTxt = inputs.diabetes.checked ? 'has type 2 diabetes' : 'has no diabetes';
        const meds = [
          inputs.acei.checked?'ACEi/ARB':null,
          inputs.statin.checked?'statin':null,
          inputs.sglt2i.checked?'SGLT2i':null,
          (inputs.mra.checked && inputs.diabetes.checked)?'MRA':null
        ].filter(Boolean).join(', ') || 'no reno-/cardio-protective meds';
        const bmi = Math.round((weight/((height/100)**2))*10)/10;
        const name = who==='arjun' ? 'Arjun' : 'Meera';
        return `${name} is a ${age}-year-old from Pune, BMI ${bmi}. ${dmTxt}, ${smokeTxt}, and ${bpTxt}. UACR ${uacr} mg/g, eGFR ${egfr} (${gfrStage(egfr)}). Medications: ${meds}.`;
      };
      if (activeProfile==='arjun') {
        arjunDesc.textContent = summary('arjun');
      } else {
        meeraDesc.textContent = summary('meera');
      }

      return { egfr, k2, k5, cvdNow };
    }

    function updateAll(){ computeState(); }

    // Bind events
    Object.values(inputs).forEach(i => {
      i.addEventListener('input', updateAll);
      i.addEventListener('change', updateAll);
    });

    // Init with Meera selected (and bug fixed)
    selectProfile('meera');
  </script>
</body>
</html>
